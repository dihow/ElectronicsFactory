// =============================================================================
// ОБЪЕДИНЕННЫЙ КОД ИЗ ДИРЕКТОРИИ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory
// ВРЕМЯ СОЗДАНИЯ: 28.11.2025 01:16:21
// ВСЕГО ФАЙЛОВ: 30
// =============================================================================


// =============================================================================
// ФАЙЛ: AdditionalRepository.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\AdditionalRepository.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing.Printing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    public class AdditionalRepository
    {
        // ========== MOVEMENT METHODS ==========

        public static List<MovementCardInfo> GetMovementsPage(int pageSize, int pageNumber, string? typeFilter = null)
        {
            int offset = (pageNumber - 1) * pageSize;

            string sql = @"SELECT * FROM movements 
                          WHERE 1=1";

            var parameters = new List<NpgsqlParameter>
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                sql += " AND movement_type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", typeFilter));
            }

            sql += " ORDER BY movement_date DESC LIMIT @limit OFFSET @offset";

            var dataTable = Database.ExecuteDataTable(sql, parameters.ToArray());
            return DataTableToMovementCardInfoList(dataTable);
        }

        public static long GetTotalMovementsCount(string? typeFilter = null)
        {
            string sql = "SELECT COUNT(*) FROM movements WHERE 1=1";
            var parameters = new List<NpgsqlParameter>();

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                sql += " AND movement_type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", typeFilter));
            }

            return Database.ExecuteScalar<long>(sql, parameters.ToArray());
        }

        public static void AddMovement(Movement movement, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO movements (movement_type, product_type, description, value, movement_date)
                          VALUES (@movementType, @productType, @description, @value, @movementDate)";

            var parameters = new[]
            {
                new NpgsqlParameter("@movementType", movement.MovementType),
                new NpgsqlParameter("@productType", movement.ProductType),
                new NpgsqlParameter("@description", movement.Description ?? (object)DBNull.Value),
                new NpgsqlParameter("@value", movement.Value),
                new NpgsqlParameter("@movementDate", movement.MovementDate)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        // ========== MOVEMENT CREATION METHODS ==========

        public static void CreatePcbMovement(string movementType, int pcbId, int quantity, string? description = null, NpgsqlTransaction? transaction = null)
        {
            var pcb = PcbRepository.GetPcbById(pcbId);
            if (pcb == null) return;

            string movementDescription = description ?? $"{movementType} {quantity} плат \"{pcb.Name}\"";

            var movement = new Movement(
                id: 0,
                movementType: movementType,
                productType: "Плата",
                description: movementDescription,
                value: quantity,
                movementDate: DateTime.Now
            );

            AddMovement(movement, transaction);
        }

        public static void CreateComponentMovement(string movementType, int componentId, int quantity, string? description = null, NpgsqlTransaction? transaction = null)
        {
            var component = PcbRepository.GetComponentById(componentId, transaction);
            if (component == null) return;

            string movementDescription = description ?? $"{movementType} {quantity} компонентов \"{component.Name}\"";

            var movement = new Movement(
                id: 0,
                movementType: movementType,
                productType: "Компонент",
                description: movementDescription,
                value: quantity,
                movementDate: DateTime.Now
            );

            AddMovement(movement, transaction);
        }

        public static void CreatePcbStockMovement(int pcbId, int oldQuantity, int newQuantity, NpgsqlTransaction? transaction = null)
        {
            int difference = newQuantity - oldQuantity;
            if (difference == 0) return;

            string movementType = difference > 0 ? "Поступление" : "Списание";
            CreatePcbMovement(movementType, pcbId, Math.Abs(difference), null, transaction);
        }

        public static void CreateComponentStockMovement(int componentId, int oldQuantity, int newQuantity, NpgsqlTransaction? transaction = null)
        {
            int difference = newQuantity - oldQuantity;
            if (difference == 0) return;

            string movementType = difference > 0 ? "Поступление" : "Списание";
            CreateComponentMovement(movementType, componentId, Math.Abs(difference), null, transaction);
        }

        public static int DeleteMovementsInPeriod(DateTime startDate, DateTime endDate, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM movements WHERE movement_date BETWEEN @startDate AND @endDate";
            var parameters = new[]
            {
        new NpgsqlParameter("@startDate", startDate),
        new NpgsqlParameter("@endDate", endDate)
    };

            if (transaction == null)
                return Database.ExecuteNonQuery(sql, parameters);
            else
                return Database.ExecuteNonQuery(sql, transaction, parameters);
        }

        public static long GetMovementsCountInPeriod(DateTime startDate, DateTime endDate)
        {
            string sql = "SELECT COUNT(*) FROM movements WHERE movement_date BETWEEN @startDate AND @endDate";
            var parameters = new[]
            {
        new NpgsqlParameter("@startDate", startDate),
        new NpgsqlParameter("@endDate", endDate)
    };

            return Database.ExecuteScalar<long>(sql, parameters);
        }

        // ========== EMPLOYEES METHODS ==========

        public static bool TryLoggingIn(string login, string password)
        {
            string sql = @"SELECT password_hash = crypt(@password, password_salt) as password_match
                          FROM employees 
                          WHERE login = @login";

            var parameters = new[]
            {
                new NpgsqlParameter("@login", login),
                new NpgsqlParameter("@password", password)
            };

            return Database.ExecuteScalar<bool>(sql, parameters);
        }

        public static EmployeeInfo? GetEmployeeInfo(string login)
        {
            string sql = @"SELECT id, full_name, is_admin FROM employees WHERE login = @login";
            var parameters = new[] { new NpgsqlParameter("@login", login) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            var row = dataTable.Rows[0];
            return new EmployeeInfo(
                Convert.ToInt32(row["id"]),
                row["full_name"].ToString() ?? "",
                Convert.ToBoolean(row["is_admin"])
            );
        }

        public class EmployeeInfo
        {
            public int Id { get; set; }
            public string FullName { get; set; }
            public bool IsAdmin { get; set; }

            public EmployeeInfo(int id, string fullName, bool isAdmin)
            {
                Id = id;
                FullName = fullName;
                IsAdmin = isAdmin;
            }
        }

        // ========== HELPER METHODS ==========

        private static List<MovementCardInfo> DataTableToMovementCardInfoList(DataTable dataTable)
        {
            var movements = new List<MovementCardInfo>();
            foreach (DataRow row in dataTable.Rows)
            {
                movements.Add(new MovementCardInfo(
                    id: Convert.ToInt32(row["id"]),
                    type: row["movement_type"].ToString() ?? "",
                    description: row["description"].ToString() ?? "",
                    date: Convert.ToDateTime(row["movement_date"])
                ));
            }
            return movements;
        }

        private static List<Movement> DataTableToMovementList(DataTable dataTable)
        {
            var movements = new List<Movement>();
            foreach (DataRow row in dataTable.Rows)
            {
                movements.Add(new Movement(
                    id: Convert.ToInt32(row["id"]),
                    movementType: row["movement_type"].ToString() ?? "",
                    productType: row["product_type"].ToString() ?? "",
                    description: row["description"].ToString(),
                    value: Convert.ToInt32(row["value"]),
                    movementDate: Convert.ToDateTime(row["movement_date"])
                ));
            }
            return movements;
        }
    }
}

// =============================================================================
// ФАЙЛ: AuthorizationForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\AuthorizationForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class AuthorizationForm : Form
    {
        public AuthorizationForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);
        }

        private void AuthorizationButton_Click(object sender, EventArgs e)
        {
            try
            {
                if (AdditionalRepository.TryLoggingIn(LoginTextBox.Text.Trim(), PasswordTextBox.Text.Trim()))
                {
                    var employeeInfo = AdditionalRepository.GetEmployeeInfo(LoginTextBox.Text.Trim());
                    if (employeeInfo != null)
                    {
                        Settings.IsAdmin = employeeInfo.IsAdmin;
                        Settings.CurrentEmployeeId = employeeInfo.Id;
                        Settings.CurrentEmployeeName = employeeInfo.FullName;

                        Hide();
                        new MainForm().Show();
                    }
                }
                else
                {
                    Utils.ShowErrorMessage("Не удалось войти в систему: неправильный логин или пароль", "Ошибка авторизации");
                }
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка авторизации:\n{ex.Message}");
            }
        }
    }
}


// =============================================================================
// ФАЙЛ: CardInfos.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\CardInfos.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    public class ClientCardInfo
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Type { get; set; }
        public string Phone { get; set; }
        public string Email { get; set; }

        public ClientCardInfo(int id, string name, string type, string phone, string email)
        {
            Id = id;
            Name = name;
            Type = type;
            Phone = phone;
            Email = email;
        }
    }

    public class PcbCardInfo
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string? Description { get; set; }
        public double Price { get; set; }
        public int Quantity { get; set; }
        public string? ImagePath { get; set; }

        public PcbCardInfo(int id, string name, string? description, double price, int quantity, string? imagePath)
        {
            Id = id;
            Name = name;
            Description = description;
            Price = price;
            Quantity = quantity;
            ImagePath = imagePath;
        }
    }

    public class ComponentCardInfo
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Type { get; set; }
        public string? Manufacturer { get; set; }
        public int StockQuantity { get; set; }
        public int? PcbCount { get; set; }
        public string? PcbCoordinates { get; set; }

        public ComponentCardInfo(int id, string name, string type, string? manufacturer,
            int stockQuantity, int? pcbCount = null, string? pcbCoordinates = null)
        {
            Id = id;
            Name = name;
            Type = type;
            Type = type;
            Manufacturer = manufacturer;
            StockQuantity = stockQuantity;
            PcbCount = pcbCount;
            PcbCoordinates = pcbCoordinates;
        }
    }

    public class OrderCardInfo
    {
        public int Id { get; set; }
        public string Client { get; set; }
        public string Status { get; set; }
        public double TotalAmount { get; set; }
        public DateTime RegistrationDate { get; set; }
        public DateTime? ShipmentDate { get; set; }

        public OrderCardInfo(int id, string client, string status, double totalAmount, DateTime registrationDate, DateTime? shipmentDate)
        {
            Id = id;
            Client = client;
            Status = status;
            TotalAmount = totalAmount;
            RegistrationDate = registrationDate;
            ShipmentDate = shipmentDate;
        }
    }

    public class MovementCardInfo
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public string? Description { get; set; }
        public DateTime Date { get; set; }

        public MovementCardInfo(int id, string type, string? description, DateTime date)
        {
            Id = id;
            Type = type;
            Description = description;
            Date = date;
        }
    }
}


// =============================================================================
// ФАЙЛ: ClientCard.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\ClientCard.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class ClientCard : UserControl
    {
        public int Id { get; set; }
        public ClientCard(ClientCardInfo info)
        {
            InitializeComponent();
            SettingsUI.StyleCard(this);

            Id = info.Id;
            NameLabel.Text = info.Name;
            TypeLabel.Text = info.Type;
            PhoneLabel.Text = $"Телефон: {info.Phone}";
            EmailLabel.Text = $"Email: {info.Email}";
        }

        private void Card_Click(object sender, EventArgs e)
        {
            OnClick(e);
        }

        private void ClientCard_Load(object sender, EventArgs e)
        {

        }
    }
}


// =============================================================================
// ФАЙЛ: ClientRepository.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\ClientRepository.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace ElectronicsFactory
{
    public static class ClientRepository
    {
        public static List<ClientCardInfo> GetFilteredClientsPage(int pageSize, int pageNumber, string? nameFilter = null, string? typeFilter = null)
        {
            var clients = new List<ClientCardInfo>();

            int offset = (pageNumber - 1) * pageSize;

            string sql = @"
                SELECT c.id, c.type, c.phone, c.email, 
                       COALESCE(i.full_name, le.company_name) as name
                FROM clients c
                LEFT JOIN individuals i ON c.id = i.client_id
                LEFT JOIN legal_entities le ON c.id = le.client_id
                WHERE 1=1";

            var parameters = new List<NpgsqlParameter>
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                string dbType = typeFilter == "Физические лица" ? "Физическое лицо" : "Юридическое лицо";
                sql += " AND c.type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", dbType));
            }

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += @" AND (COALESCE(i.full_name, le.company_name) ILIKE @nameFilter)
                          ORDER BY 
                            CASE 
                              WHEN COALESCE(i.full_name, le.company_name) ILIKE @namePatternStart THEN 1
                              WHEN COALESCE(i.full_name, le.company_name) ILIKE @namePatternAny THEN 2
                              ELSE 3
                            END,
                            COALESCE(i.full_name, le.company_name)";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternStart", $"{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternAny", $"%{nameFilter}%"));
            }
            else
            {
                sql += " ORDER BY c.id";
            }

            sql += " LIMIT @limit OFFSET @offset";

            var dataTable = Database.ExecuteDataTable(sql, parameters.ToArray());

            foreach (DataRow row in dataTable.Rows)
            {
                var clientInfo = new ClientCardInfo(
                    id: Convert.ToInt32(row["id"]),
                    name: row["name"].ToString() ?? "",
                    type: row["type"].ToString() ?? "",
                    phone: row["phone"].ToString() ?? "",
                    email: row["email"].ToString() ?? ""
                );
                clients.Add(clientInfo);
            }

            return clients;
        }

        public static long GetFilteredClientsCount(string? nameFilter = null, string? typeFilter = null)
        {
            string sql = @"
                SELECT COUNT(*) 
                FROM clients c
                LEFT JOIN individuals i ON c.id = i.client_id
                LEFT JOIN legal_entities le ON c.id = le.client_id
                WHERE 1=1";

            var parameters = new List<NpgsqlParameter>();

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                string dbType = typeFilter == "Физические лица" ? "Физическое лицо" : "Юридическое лицо";
                sql += " AND c.type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", dbType));
            }

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += " AND (COALESCE(i.full_name, le.company_name) ILIKE @nameFilter)";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
            }

            return Database.ExecuteScalar<long>(sql, parameters.ToArray());
        }

        public static List<ClientComboBoxItem> GetAllClientsForComboBox()
        {
            var clients = new List<ClientComboBoxItem>();

            string sql = @"
        SELECT c.id, COALESCE(i.full_name, le.company_name) as name
        FROM clients c
        LEFT JOIN individuals i ON c.id = i.client_id
        LEFT JOIN legal_entities le ON c.id = le.client_id
        ORDER BY name";

            var dataTable = Database.ExecuteDataTable(sql);

            foreach (DataRow row in dataTable.Rows)
            {
                clients.Add(new ClientComboBoxItem
                {
                    Id = Convert.ToInt32(row["id"]),
                    Name = row["name"].ToString() ?? "Неизвестный клиент"
                });
            }

            return clients;
        }

        public class ClientComboBoxItem
        {
            public int Id { get; set; }
            public string Name { get; set; }
        }

        public static Client? GetClientById(int id)
        {
            string sql = "SELECT id, type, phone, email, inn FROM clients WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            var row = dataTable.Rows[0];
            return new Client(
                id: Convert.ToInt32(row["id"]),
                type: row["type"].ToString() ?? "",
                phone: row["phone"].ToString() ?? "",
                email: row["email"].ToString() ?? "",
                inn: row["inn"].ToString() ?? ""
            );
        }

        public static Individual? GetIndividualById(int clientId)
        {
            string sql = "SELECT client_id, full_name, address, age FROM individuals WHERE client_id = @clientId";
            var parameters = new[] { new NpgsqlParameter("@clientId", clientId) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            var row = dataTable.Rows[0];
            return new Individual(
                clientId: Convert.ToInt32(row["client_id"]),
                fullName: row["full_name"].ToString() ?? "",
                address: row["address"].ToString() ?? "",
                age: Convert.ToInt32(row["age"])
            );
        }

        public static LegalEntity? GetLegalEntityById(int clientId)
        {
            string sql = @"SELECT client_id, company_name, contact_person, legal_address, actual_address 
                          FROM legal_entities WHERE client_id = @clientId";
            var parameters = new[] { new NpgsqlParameter("@clientId", clientId) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            var row = dataTable.Rows[0];
            return new LegalEntity(
                clientId: Convert.ToInt32(row["client_id"]),
                companyName: row["company_name"].ToString() ?? "",
                contactPerson: row["contact_person"].ToString() ?? "",
                legalAddress: row["legal_address"].ToString() ?? "",
                actualAddress: row["actual_address"].ToString() ?? ""
            );
        }

        public static int AddClient(Client client, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO clients (type, phone, email, inn)
                          VALUES (@type, @phone, @email, @inn)
                          RETURNING id";
            var parameters = new[]
            {
                new NpgsqlParameter("@type", client.Type),
                new NpgsqlParameter("@phone", client.Phone ?? (object)DBNull.Value),
                new NpgsqlParameter("@email", client.Email ?? (object)DBNull.Value),
                new NpgsqlParameter("@inn", client.Inn ?? (object)DBNull.Value)
            };

            if (transaction == null)
            {
                return Database.ExecuteScalar<int>(sql, parameters);
            }
            else
            {
                return Database.ExecuteScalar<int>(sql, transaction, parameters);
            }
        }

        public static void AddIndividual(Individual individual, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO individuals (client_id, full_name, address, age)
                          VALUES (@clientId, @fullName, @address, @age)";
            var parameters = new[]
            {
                new NpgsqlParameter("@fullName", individual.FullName),
                new NpgsqlParameter("@address", individual.Address ?? (object)DBNull.Value),
                new NpgsqlParameter("@age", individual.Age ?? (object)DBNull.Value),
                new NpgsqlParameter("@clientId", individual.ClientId)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void AddLegalEntity(LegalEntity legalEntity, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO legal_entities
                         VALUES (@clientId, @companyName, @contactPerson, @legalAddress, @actualAddress)";
            var parameters = new[]
            {
                new NpgsqlParameter("@companyName", legalEntity.CompanyName),
                new NpgsqlParameter("@contactPerson", legalEntity.ContactPerson ?? (object)DBNull.Value),
                new NpgsqlParameter("@legalAddress", legalEntity.LegalAddress ?? (object)DBNull.Value),
                new NpgsqlParameter("@actualAddress", legalEntity.ActualAddress ?? (object)DBNull.Value),
                new NpgsqlParameter("@clientId", legalEntity.ClientId)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdateClient(Client client, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE clients SET type = @type, phone = @phone, email = @email, inn = @inn 
                          WHERE id = @id";
            var parameters = new[]
            {
                new NpgsqlParameter("@type", client.Type),
                new NpgsqlParameter("@phone", client.Phone ?? (object)DBNull.Value),
                new NpgsqlParameter("@email", client.Email ?? (object)DBNull.Value),
                new NpgsqlParameter("@inn", client.Inn ?? (object)DBNull.Value),
                new NpgsqlParameter("@id", client.Id)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdateIndividual(Individual individual, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE individuals SET full_name = @fullName, address = @address, age = @age 
                          WHERE client_id = @clientId";
            var parameters = new[]
            {
                new NpgsqlParameter("@fullName", individual.FullName),
                new NpgsqlParameter("@address", individual.Address ?? (object)DBNull.Value),
                new NpgsqlParameter("@age", individual.Age ?? (object)DBNull.Value),
                new NpgsqlParameter("@clientId", individual.ClientId)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdateLegalEntity(LegalEntity legalEntity, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE legal_entities SET company_name = @companyName, 
                          contact_person = @contactPerson, legal_address = @legalAddress, 
                          actual_address = @actualAddress WHERE client_id = @clientId";
            var parameters = new[]
            {
                new NpgsqlParameter("@companyName", legalEntity.CompanyName),
                new NpgsqlParameter("@contactPerson", legalEntity.ContactPerson ?? (object)DBNull.Value),
                new NpgsqlParameter("@legalAddress", legalEntity.LegalAddress ?? (object)DBNull.Value),
                new NpgsqlParameter("@actualAddress", legalEntity.ActualAddress ?? (object)DBNull.Value),
                new NpgsqlParameter("@clientId", legalEntity.ClientId)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteIndividual(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = @"DELETE FROM individuals WHERE client_id = @clientId";
            var parameters = new[]
            {
                new NpgsqlParameter("@clientId", id)
            };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteLegalEntity(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = @"DELETE FROM legal_entities WHERE client_id = @clientId";
            var parameters = new[]
            {
                new NpgsqlParameter("@clientId", id)
            };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteClient(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = @"DELETE FROM clients WHERE id = @id";
            var parameters = new[]
            {
                new NpgsqlParameter("@id", id)
            };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteClientWithDependencies(int clientId, NpgsqlTransaction? transaction = null)
        {
            var client = GetClientById(clientId);
            if (client == null) return;

            var clientOrders = OrderRepository.GetOrdersByClientId(clientId);
            if (clientOrders.Count > 0)
            {
                throw new Exception("Невозможно удалить клиента, у которого есть заказы. Сначала удалите все заказы клиента.");
            }

            if (client.Type == "Физическое лицо")
            {
                DeleteIndividual(clientId, transaction);
            }
            else
            {
                DeleteLegalEntity(clientId, transaction);
            }

            DeleteClient(clientId, transaction);
        }
    }
}

// =============================================================================
// ФАЙЛ: ClientsListForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\ClientsListForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Printing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class ClientsListForm : Form
    {
        private int _pageSize = 3;
        private int _currentPage = 1;
        private int _totalPages = 1;
        private string _currentNameFilter = "";
        private string _currentTypeFilter = "Все";
        private Label _noResultsLabel;

        public ClientsListForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            InitializeNoResultsLabel();
            LoadClientsPage();
            UpdatePaginationButtons();
            TypeFilterComboBox.SelectedItem = "Все";
        }

        private void InitializeNoResultsLabel()
        {
            _noResultsLabel = new Label();
            _noResultsLabel.Text = "Клиенты не найдены";
            _noResultsLabel.AutoSize = true;
            _noResultsLabel.Font = new Font("Times New Roman", 12F, FontStyle.Italic, GraphicsUnit.Point, 204);
            _noResultsLabel.ForeColor = Color.Gray;
            _noResultsLabel.Visible = false;
            flowLayoutPanel1.Controls.Add(_noResultsLabel);
        }

        private void LoadClientsPage()
        {
            // Очищаем панель
            flowLayoutPanel1.Controls.Clear();
            flowLayoutPanel1.Controls.Add(_noResultsLabel);

            // Получаем данные для текущей страницы с фильтрами
            var clients = ClientRepository.GetFilteredClientsPage(_pageSize, _currentPage, _currentNameFilter, _currentTypeFilter);
            long totalClients = ClientRepository.GetFilteredClientsCount(_currentNameFilter, _currentTypeFilter);
            _totalPages = (int)Math.Ceiling((double)totalClients / _pageSize);

            if (_totalPages == 0) _totalPages = 1;

            // Показываем/скрываем сообщение о пустом результате
            if (clients.Count == 0)
            {
                _noResultsLabel.Visible = true;
            }
            else
            {
                _noResultsLabel.Visible = false;

                // Создаем и добавляем карточки
                foreach (var info in clients)
                {
                    var card = new ClientCard(info);
                    card.Click += Card_Click!;
                    flowLayoutPanel1.Controls.Add(card);
                }
            }

            // Обновляем информацию о странице
            UpdatePageInfo();
            UpdatePaginationButtons();
        }

        private void Card_Click(object sender, EventArgs e)
        {
            var card = (ClientCard)sender;
            new EditClientForm(card.Id).ShowDialog();
            LoadClientsPage(); // Перезагружаем с текущими фильтрами
        }

        private void UpdatePageInfo()
        {
            PageLabel.Text = $"Страница {_currentPage} из {_totalPages}";
        }

        private void UpdatePaginationButtons()
        {
            PrevButton.Enabled = _currentPage > 1;
            NextButton.Enabled = _currentPage < _totalPages;
        }

        private void PrevPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                LoadClientsPage();
            }
        }

        private void NextPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                LoadClientsPage();
            }
        }

        private void AddClientButton_Click(object sender, EventArgs e)
        {
            new EditClientForm().ShowDialog();
            LoadClientsPage(); // Перезагружаем с текущими фильтрами
        }

        private void FilterButton_Click(object sender, EventArgs e)
        {
            // Применяем фильтры
            _currentNameFilter = NameFilterTextBox.Text.Trim();
            _currentTypeFilter = TypeFilterComboBox.SelectedItem?.ToString() ?? "Все";

            // Сбрасываем на первую страницу при применении новых фильтров
            _currentPage = 1;

            LoadClientsPage();
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void NameFilterTextBox_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                FilterButton_Click(sender, e);
                e.Handled = true;
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: ComponentCard.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\ComponentCard.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class ComponentCard : UserControl
    {
        public int Id { get; set; }
        public string ComponentName { get; set; }

        public ComponentCard(ComponentCardInfo info)
        {
            InitializeComponent();

            Id = info.Id;
            ComponentName = info.Name;
            NameLabel.Text = info.Name;
            TypeLabel.Text = info.Type;
            ManufacturerLabel.Text = info.PcbCount.HasValue ?
                $"Количество на плате: {info.PcbCount.Value}" : $"Производитель: {info.Manufacturer}";
            QuantityLabel.Text = info.PcbCoordinates != null ?
                $"Координаты: {info.PcbCoordinates}" : $"На складе: {info.StockQuantity}";

            SettingsUI.StyleCard(this);
        }

        private void Card_Click(object sender, EventArgs e)
        {
            OnClick(e);
        }

        private void ComponentCard_Paint(object sender, PaintEventArgs e)
        {
            SettingsUI.StyleCard(this);
        }
    }
}


// =============================================================================
// ФАЙЛ: ComponentsListForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\ComponentsListForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Printing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class ComponentsListForm : Form
    {
        private int _pageSize = 3;
        private int _currentPage = 1;
        private int _totalPages = 1;
        private string _currentNameFilter = "";
        private string _currentTypeFilter = "Все";
        private Label _noResultsLabel;
        private bool _isPcbComponents;
        private int? _pcbId;

        public ComponentsListForm(int? pcbId = null)
        {
            _isPcbComponents = pcbId != null;
            _pcbId = pcbId;
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            InitializeNoResultsLabel();
            LoadComponentsPage();
            UpdatePaginationButtons();
        }

        private void InitializeNoResultsLabel()
        {
            _noResultsLabel = new Label();
            _noResultsLabel.Text = "Компоненты не найдены";
            _noResultsLabel.AutoSize = true;
            _noResultsLabel.Font = new Font("Times New Roman", 12F, FontStyle.Italic, GraphicsUnit.Point, 204);
            _noResultsLabel.ForeColor = Color.Gray;
            _noResultsLabel.Visible = false;
            flowLayoutPanel1.Controls.Add(_noResultsLabel);
        }

        private void LoadComponentsPage()
        {
            // Очищаем панель
            flowLayoutPanel1.Controls.Clear();
            flowLayoutPanel1.Controls.Add(_noResultsLabel);

            // Получаем данные для текущей страницы с фильтрами
            var components = PcbRepository.GetFilteredComponentsPage(_pageSize, _currentPage, _currentNameFilter, _currentTypeFilter, _pcbId);
            long totalComponents = PcbRepository.GetFilteredComponentsCount(_currentNameFilter, _currentTypeFilter, _pcbId);
            _totalPages = (int)Math.Ceiling((double)totalComponents / _pageSize);

            if (_totalPages == 0) _totalPages = 1;

            // Показываем/скрываем сообщение о пустом результате
            if (components.Count == 0)
            {
                _noResultsLabel.Visible = true;
            }
            else
            {
                _noResultsLabel.Visible = false;

                // Создаем и добавляем карточки
                foreach (var info in components)
                {
                    var card = new ComponentCard(info);
                    card.Click += Card_Click!;
                    flowLayoutPanel1.Controls.Add(card);
                }
            }

            // Обновляем информацию о странице
            UpdatePageInfo();
            UpdatePaginationButtons();
        }

        private void Card_Click(object sender, EventArgs e)
        {
            var card = (ComponentCard)sender;
            if (_isPcbComponents && _pcbId.HasValue)
            {
                new EditPcbComponentForm(_pcbId.Value, card.Id, card.ComponentName).ShowDialog();
            }
            else
            {
                new EditComponentForm(card.Id).ShowDialog();
            }
            LoadComponentsPage();
        }

        private void UpdatePageInfo()
        {
            PageLabel.Text = $"Страница {_currentPage} из {_totalPages}";
        }

        private void UpdatePaginationButtons()
        {
            PrevButton.Enabled = _currentPage > 1;
            NextButton.Enabled = _currentPage < _totalPages;
        }

        private void PrevPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                LoadComponentsPage();
            }
        }

        private void NextPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                LoadComponentsPage();
            }
        }

        private void AddComponentButton_Click(object sender, EventArgs e)
        {
            if (_isPcbComponents && _pcbId.HasValue)
            {
                new EditPcbComponentForm(_pcbId.Value).ShowDialog();
            }
            else
            {
                new EditComponentForm().ShowDialog();
            }
            LoadComponentsPage();
        }

        private void FilterButton_Click(object sender, EventArgs e)
        {
            _currentNameFilter = NameFilterTextBox.Text.Trim();
            _currentTypeFilter = TypeFilterComboBox.SelectedItem?.ToString() ?? "Все";

            _currentPage = 1;

            LoadComponentsPage();
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void NameFilterTextBox_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                FilterButton_Click(sender, e);
                e.Handled = true;
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: Database.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\Database.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    internal static class Database
    {
        private static string _connectionString;

        public static void Initialize(string connectionString)
        {
            _connectionString = connectionString;
        }

        // ==============================================================================
        // Методы для выполнения запросов БЕЗ транзакции (самостоятельно управляют соединением)
        // ==============================================================================

        // Метод для выполнения запросов без возврата данных
        public static int ExecuteNonQuery(string sql, params NpgsqlParameter[] parameters)
        {
            using var connection = new NpgsqlConnection(_connectionString);
            using var command = new NpgsqlCommand(sql, connection);

            command.Parameters.AddRange(parameters);
            connection.Open();

            return command.ExecuteNonQuery();
        }

        // Универсальный метод для запросов с возвратом данных
        public static T? ExecuteScalar<T>(string sql, params NpgsqlParameter[] parameters)
        {
            using var connection = new NpgsqlConnection(_connectionString);
            using var command = new NpgsqlCommand(sql, connection);

            command.Parameters.AddRange(parameters);
            connection.Open();

            var result = command.ExecuteScalar();
            return result == DBNull.Value || result == null ? default(T) : (T)result;
        }

        // Метод для получения DataTable
        public static DataTable ExecuteDataTable(string sql, params NpgsqlParameter[] parameters)
        {
            using var connection = new NpgsqlConnection(_connectionString);
            connection.Open();
            using var command = new NpgsqlCommand(sql, connection);
            using var adapter = new NpgsqlDataAdapter(command);

            command.Parameters.AddRange(parameters);
            var dataTable = new DataTable();
            adapter.Fill(dataTable);
            // connection.Close(); // Адаптер обычно закрывает соединение, если оно было открыто им, но явное закрытие через 'using' блок command и adapter гарантирует это.
            // Для connection, 'using' блок тоже закроет его.
            return dataTable;
        }

        // Метод для получения списка объектов
        public static List<T> ExecuteReader<T>(string sql, Func<NpgsqlDataReader, T> mapper, params NpgsqlParameter[] parameters)
        {
            var results = new List<T>();

            using var connection = new NpgsqlConnection(_connectionString);
            using var command = new NpgsqlCommand(sql, connection);

            command.Parameters.AddRange(parameters);
            connection.Open();

            using var reader = command.ExecuteReader();
            while (reader.Read())
            {
                results.Add(mapper(reader));
            }

            return results;
        }

        // ==============================================================================
        // Методы для выполнения запросов ВНУТРИ ТРАНЗАКЦИИ (принимают только NpgsqlTransaction)
        // ==============================================================================

        public static int ExecuteNonQuery(string sql, NpgsqlTransaction transaction, params NpgsqlParameter[] parameters)
        {
            // Используем transaction.Connection для создания команды
            using var command = new NpgsqlCommand(sql, transaction.Connection!, transaction); // '!' для уверенности, что Connection не null
            command.Parameters.AddRange(parameters);
            return command.ExecuteNonQuery();
        }

        public static T? ExecuteScalar<T>(string sql, NpgsqlTransaction transaction, params NpgsqlParameter[] parameters)
        {
            // Используем transaction.Connection для создания команды
            using var command = new NpgsqlCommand(sql, transaction.Connection!, transaction);
            command.Parameters.AddRange(parameters);
            var result = command.ExecuteScalar();
            return result == DBNull.Value || result == null ? default(T) : (T)result;
        }

        public static DataTable ExecuteDataTable(string sql, NpgsqlTransaction transaction, params NpgsqlParameter[] parameters)
        {
            // Используем transaction.Connection для создания команды
            using var command = new NpgsqlCommand(sql, transaction.Connection!, transaction);
            using var adapter = new NpgsqlDataAdapter(command);

            command.Parameters.AddRange(parameters);
            var dataTable = new DataTable();
            adapter.Fill(dataTable);
            return dataTable;
        }

        // Добавим версию ExecuteReader для транзакции, если нужна
        public static List<T> ExecuteReader<T>(string sql, Func<NpgsqlDataReader, T> mapper, NpgsqlTransaction transaction, params NpgsqlParameter[] parameters)
        {
            var results = new List<T>();

            using var command = new NpgsqlCommand(sql, transaction.Connection!, transaction);
            command.Parameters.AddRange(parameters);

            using var reader = command.ExecuteReader();
            while (reader.Read())
            {
                results.Add(mapper(reader));
            }

            return results;
        }


        // ==============================================================================
        // TransactionManager
        // ==============================================================================
        public static class TransactionManager
        {
            // Изменяем сигнатуру, чтобы не передавать NpgsqlConnection в action/function
            public static void ExecuteInTransaction(Action<NpgsqlTransaction> action)
            {
                using var connection = new NpgsqlConnection(_connectionString);
                connection.Open();
                using var transaction = connection.BeginTransaction();

                try
                {
                    action(transaction); // Передаем только транзакцию
                    transaction.Commit();
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }

            // Изменяем сигнатуру, чтобы не передавать NpgsqlConnection в action/function
            public static T ExecuteInTransaction<T>(Func<NpgsqlTransaction, T> function)
            {
                using var connection = new NpgsqlConnection(_connectionString);
                connection.Open();
                using var transaction = connection.BeginTransaction();

                try
                {
                    var result = function(transaction); // Передаем только транзакцию
                    transaction.Commit();
                    return result;
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }
    }
}


// =============================================================================
// ФАЙЛ: EditClientForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\EditClientForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class EditClientForm : Form
    {
        private int? _clientId;
        private Client? _client;
        private Individual? _individual;
        private LegalEntity? _legalEntity;
        private const string individualType = "Физическое лицо";
        private const string legalEntityType = "Юридическое лицо";
        private bool _isEditMode;
        private string? _initialClientType;

        public EditClientForm(int? clientId = null)
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            _clientId = clientId;
            _isEditMode = clientId != null;
            if (!_isEditMode)
            {
                _initialClientType = individualType;
                TypeComboBox.SelectedItem = individualType;
            }
            LoadData();
            ChangeControls(_initialClientType!);
            if (_isEditMode)
            {
                FillFields();
                if (Settings.IsAdmin)
                {
                    DeleteButton.Visible = true;
                }
            }
        }

        private void LoadData()
        {
            if (_clientId != null)
            {
                _client = ClientRepository.GetClientById(_clientId.Value);
                if (_client != null)
                {
                    _initialClientType = _client.Type;
                    if (_client.Type == individualType)
                    {
                        _individual = ClientRepository.GetIndividualById(_clientId.Value);
                        if (_individual == null)
                        {
                            Utils.ShowErrorMessage("Не удалось получить физическое лицо");
                            Close();
                        }
                    }
                    else
                    {
                        _legalEntity = ClientRepository.GetLegalEntityById(_clientId.Value);
                        if (_legalEntity == null)
                        {
                            Utils.ShowErrorMessage("Не удалось получить юридическое лицо");
                            Close();
                        }
                    }
                }
                else
                {
                    Utils.ShowErrorMessage("Не удалось получить клиента");
                    Close();
                }
            }
        }

        private void FillFields()
        {
            TypeComboBox.SelectedItem = _client!.Type;
            PhoneTextBox.Text = _client!.Phone;
            EmailTextBox.Text = _client!.Email;

            if (_client!.Type == individualType)
            {
                IndividualInnTextBox.Text = _client.Inn;
                NameTextBox.Text = _individual!.FullName;
                AddressTextBox.Text = _individual.Address;
                if (_individual.Age.HasValue)
                {
                    AgeNumeric.Value = _individual.Age.Value;
                }
            }
            else
            {
                LegalEntityInnTextBox.Text = _client!.Inn;
                NameTextBox.Text = _legalEntity!.CompanyName;
                ContactPersonTextBox.Text = _legalEntity.ContactPerson;
                LegalAddressTextBox.Text = _legalEntity.LegalAddress;
                ActualAddressTextBox.Text = _legalEntity.ActualAddress;
            }
        }

        private void ChangeControls(string type)
        {
            if (type == individualType)
            {
                LegalEntityInnTextBox.Visible = false;
                ContactPersonTextBox.Visible = false;
                LegalAddressTextBox.Visible = false;
                ActualAddressTextBox.Visible = false;
                ActualAddressLabel.Visible = false;
                CompanyNameLabel.Visible = false;
                ContactPersonLabel.Visible = false;
                LegalAddressLabel.Visible = false;

                IndividualInnTextBox.Visible = true;
                AddressTextBox.Visible = true;
                AgeNumeric.Visible = true;
                NameLabel.Visible = true;
                AddressLabel.Visible = true;
                AgeLabel.Visible = true;
            }
            else
            {
                LegalEntityInnTextBox.Visible = true;
                ContactPersonTextBox.Visible = true;
                LegalAddressTextBox.Visible = true;
                ActualAddressTextBox.Visible = true;
                ActualAddressLabel.Visible = true;
                CompanyNameLabel.Visible = true;
                ContactPersonLabel.Visible = true;
                LegalAddressLabel.Visible = true;

                IndividualInnTextBox.Visible = false;
                AddressTextBox.Visible = false;
                AgeNumeric.Visible = false;
                NameLabel.Visible = false;
                AddressLabel.Visible = false;
                AgeLabel.Visible = false;
            }
        }

        private bool ValidateData()
        {
            bool innIsEmpty = TypeComboBox.Text == individualType ?
                IndividualInnTextBox.Text.Length != 12 : LegalEntityInnTextBox.Text.Length != 10;
            string phoneText = PhoneTextBox.Text.Replace(" ", "").Replace("-", "").Replace("(", "").Replace(")", "");
            if (NameTextBox.Text == "" || phoneText.Length != 10 || innIsEmpty)
            {
                Utils.ShowErrorMessage("Не заполнены необходимые поля!");
                return false;
            }
            return true;
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            if (!ValidateData())
            {
                return;
            }
            try
            {
                Database.TransactionManager.ExecuteInTransaction(transaction =>
                {
                    string? type = TypeComboBox.SelectedItem!.ToString();
                    if (type == null)
                    {
                        return;
                    }
                    _client = new Client(
                        id: _isEditMode ? _clientId!.Value : -1,
                        type: type,
                        phone: PhoneTextBox.Text,
                        email: EmailTextBox.Text,
                        inn: type == individualType ? IndividualInnTextBox.Text : LegalEntityInnTextBox.Text
                    );
                    if (_isEditMode)
                    {
                        ClientRepository.UpdateClient(_client, transaction);
                    }
                    else
                    {
                        _client.Id = ClientRepository.AddClient(_client, transaction);
                    }
                    if (type == individualType)
                    {
                        _individual = new Individual(
                            clientId: _client.Id,
                            fullName: NameTextBox.Text,
                            address: AddressTextBox.Text,
                            age: Convert.ToInt32(AgeNumeric.Value)
                        );
                        if (_isEditMode)
                        {
                            if (type == _initialClientType)
                            {
                                ClientRepository.UpdateIndividual(_individual, transaction);
                            }
                            else
                            {
                                ClientRepository.DeleteLegalEntity(_clientId!.Value, transaction);
                                ClientRepository.AddIndividual(_individual, transaction);
                            }
                        }
                        else
                        {
                            ClientRepository.AddIndividual(_individual, transaction);
                        }
                    }
                    else
                    {
                        _legalEntity = new LegalEntity(
                            clientId: _client.Id,
                            companyName: NameTextBox.Text,
                            contactPerson: ContactPersonTextBox.Text,
                            legalAddress: LegalAddressTextBox.Text,
                            actualAddress: ActualAddressTextBox.Text
                        );
                        if (_isEditMode)
                        {
                            if (type == _initialClientType)
                            {
                                ClientRepository.UpdateLegalEntity(_legalEntity, transaction);
                            }
                            else
                            {
                                ClientRepository.DeleteIndividual(_clientId!.Value, transaction);
                                ClientRepository.AddLegalEntity(_legalEntity, transaction);
                            }
                        }
                        else
                        {
                            ClientRepository.AddLegalEntity(_legalEntity, transaction);
                        }
                    }
                });
                Utils.ShowInfoMessage("Данные были сохранены успешно");
                Close();
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при попытке сохранения данных: {ex.Message}");
            }
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage() == DialogResult.Yes)
            {
                Close();
            }
        }

        private void TypeComboBox_SelectedIndexChanged(object sender, EventArgs e)
        {
            string? type = TypeComboBox.SelectedItem?.ToString();
            if (type != null)
            {
                ChangeControls(type);
            }
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage("Вы уверены, что хотите удалить эту запись?") == DialogResult.Yes)
            {
                try
                {
                    Database.TransactionManager.ExecuteInTransaction(transaction =>
                    {
                        ClientRepository.DeleteClientWithDependencies(_clientId!.Value, transaction);
                    });

                    Utils.ShowInfoMessage("Запись удалена успешно");
                    Close();
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении:\n{ex.Message}");
                }
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: EditComponentForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\EditComponentForm.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class EditComponentForm : Form
    {
        private int? _componentId;
        private Component? _component;
        private bool _isEditMode;
        private List<ComponentSpecification> _specifications;
        private ComponentType _currentComponentType;

        public EditComponentForm(int? componentId = null)
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            _componentId = componentId;
            _isEditMode = componentId != null;
            _specifications = new List<ComponentSpecification>();

            if (_isEditMode)
            {
                LoadData();
                FillFields();
                if (Settings.IsAdmin)
                {
                    DeleteButton.Visible = true;
                }
            }
            else
            {
                // Устанавливаем тип по умолчанию для нового компонента
                TypeComboBox.SelectedIndex = 0;
            }
        }

        private void LoadData()
        {
            try
            {
                _component = PcbRepository.GetComponentById(_componentId!.Value);
                if (_component == null)
                {
                    Utils.ShowErrorMessage("Не удалось загрузить компонент");
                    Close();
                }

                // Загружаем спецификации
                _specifications = PcbRepository.GetComponentSpecifications(_componentId.Value);

                // Определяем тип компонента
                _currentComponentType = MapComponentType(_component.Type);
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Не удалось загрузить компонент:\n{ex.Message}");
                Close();
            }
        }

        private ComponentType MapComponentType(string type)
        {
            return type?.ToLower() switch
            {
                "резистор" => ComponentType.Resistor,
                "конденсатор" => ComponentType.Capacitor,
                "диод" => ComponentType.Diode,
                "транзистор" => ComponentType.Transistor,
                "микроконтроллер" => ComponentType.Microcontroller,
                _ => ComponentType.Other
            };
        }

        private string MapComponentType(ComponentType type)
        {
            return type switch
            {
                ComponentType.Resistor => "Резистор",
                ComponentType.Capacitor => "Конденсатор",
                ComponentType.Diode => "Диод",
                ComponentType.Transistor => "Транзистор",
                ComponentType.Microcontroller => "Микроконтроллер",
                _ => "Другое"
            };
        }

        private void FillFields()
        {
            if (_component != null)
            {
                NameTextBox.Text = _component.Name;
                ManufacturerTextBox.Text = _component.Manufacturer ?? "";
                PriceNumeric.Value = _component.Price;
                StockQuantity.Value = _component.StockQuantity;

                // Устанавливаем тип и обновляем спецификации
                TypeComboBox.SelectedItem = _component.Type;
                LoadSpecificationsFromDatabase();
            }
        }

        private void LoadSpecificationsFromDatabase()
        {
            // Очищаем NumericUpDown
            FirstSpecificationNumeric.Value = 0;
            SecondSpecificationNumeric.Value = 0;
            ThirdSpecificationNumeric.Value = 0;

            // Заполняем значения из спецификаций
            foreach (var spec in _specifications)
            {
                if (decimal.TryParse(spec.SpecificationValue, out decimal value))
                {
                    switch (spec.Specification)
                    {
                        case ComponentSpecification.RESISTANCE:
                        case ComponentSpecification.CAPACITANCE:
                        case ComponentSpecification.VOLTAGE_DROP:
                            FirstSpecificationNumeric.Value = value;
                            break;
                        case ComponentSpecification.TOLERANCE:
                        case ComponentSpecification.VOLTAGE:
                        case ComponentSpecification.REVERSE_VOLTAGE:
                            SecondSpecificationNumeric.Value = value;
                            break;
                        case ComponentSpecification.POWER:
                        case ComponentSpecification.MAX_TEMPERATURE:
                        case ComponentSpecification.FORWARD_CURRENT:
                            ThirdSpecificationNumeric.Value = value;
                            break;
                    }
                }
            }
        }

        private void ChangeSpecifications(ComponentType type)
        {
            _currentComponentType = type;

            switch (type)
            {
                case ComponentType.Resistor:
                    SpecificationsGroupBox.Text = "Характеристики резистора";

                    FirstSpecificationLabel.Text = "Сопротивление, Ом:";
                    SecondSpecificationLabel.Text = "Допуск, %:";
                    ThirdSpecificationLabel.Text = "Мощность, Вт:";

                    FirstSpecificationNumeric.DecimalPlaces = 2;
                    SecondSpecificationNumeric.DecimalPlaces = 1;
                    ThirdSpecificationNumeric.DecimalPlaces = 2;

                    FirstSpecificationNumeric.Maximum = 10000000; // 10 МОм
                    SecondSpecificationNumeric.Maximum = 20; // 20%
                    ThirdSpecificationNumeric.Maximum = 100; // 100 Вт
                    break;

                case ComponentType.Capacitor:
                    SpecificationsGroupBox.Text = "Характеристики конденсатора";

                    FirstSpecificationLabel.Text = "Ёмкость, мкФ:";
                    SecondSpecificationLabel.Text = "Напряжение, В:";
                    ThirdSpecificationLabel.Text = "Макс. температура, °C:";

                    FirstSpecificationNumeric.DecimalPlaces = 2;
                    SecondSpecificationNumeric.DecimalPlaces = 0;
                    ThirdSpecificationNumeric.DecimalPlaces = 0;

                    FirstSpecificationNumeric.Maximum = 100000; // 100 000 мкФ
                    SecondSpecificationNumeric.Maximum = 1000; // 1000 В
                    ThirdSpecificationNumeric.Maximum = 200; // 200°C
                    break;

                case ComponentType.Diode:
                    SpecificationsGroupBox.Text = "Характеристики диода";

                    FirstSpecificationLabel.Text = "Падение напряжения, В:";
                    SecondSpecificationLabel.Text = "Обратное напряжение, В:";
                    ThirdSpecificationLabel.Text = "Прямой ток, А:";

                    FirstSpecificationNumeric.DecimalPlaces = 2;
                    SecondSpecificationNumeric.DecimalPlaces = 0;
                    ThirdSpecificationNumeric.DecimalPlaces = 3;

                    FirstSpecificationNumeric.Maximum = 10; // 10 В
                    SecondSpecificationNumeric.Maximum = 1000; // 1000 В
                    ThirdSpecificationNumeric.Maximum = 100; // 100 А
                    break;

                default:
                    // Скрываем спецификации для других типов
                    FirstSpecificationLabel.Visible = false;
                    SecondSpecificationLabel.Visible = false;
                    ThirdSpecificationLabel.Visible = false;
                    FirstSpecificationNumeric.Visible = false;
                    SecondSpecificationNumeric.Visible = false;
                    ThirdSpecificationNumeric.Visible = false;
                    return;
            }

            // Показываем спецификации для основных типов
            FirstSpecificationLabel.Visible = true;
            SecondSpecificationLabel.Visible = true;
            ThirdSpecificationLabel.Visible = true;
            FirstSpecificationNumeric.Visible = true;
            SecondSpecificationNumeric.Visible = true;
            ThirdSpecificationNumeric.Visible = true;
        }

        private bool ValidateData()
        {
            if (string.IsNullOrWhiteSpace(NameTextBox.Text))
            {
                Utils.ShowErrorMessage("Название компонента не может быть пустым!");
                return false;
            }

            if (string.IsNullOrWhiteSpace(ManufacturerTextBox.Text))
            {
                Utils.ShowErrorMessage("Производитель не может быть пустым!");
                return false;
            }

            return true;
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            if (!ValidateData())
                return;
            try
            {
                Database.TransactionManager.ExecuteInTransaction(transaction =>
                {
                    string componentType = MapComponentType(_currentComponentType);

                    if (!_isEditMode)
                    {
                        _component = new Component(
                            id: 0,
                            name: NameTextBox.Text.Trim(),
                            manufacturer: ManufacturerTextBox.Text.Trim(),
                            price: PriceNumeric.Value,
                            type: componentType,
                            stockQuantity: (int)StockQuantity.Value,
                            createdAt: DateTime.Now
                        );

                        _component.Id = PcbRepository.AddComponent(_component, transaction);

                        if (_component.StockQuantity > 0)
                        {
                            AdditionalRepository.CreateComponentMovement("Поступление", _component.Id,
                                _component.StockQuantity, $"Поступление на склад {_component.StockQuantity} компонентов \"{_component.Name}\"", transaction);
                        }
                    }
                    else
                    {
                        int oldStock = _component!.StockQuantity;
                        int newStock = (int)StockQuantity.Value;

                        _component = new Component(
                            id: _componentId!.Value,
                            name: NameTextBox.Text.Trim(),
                            manufacturer: ManufacturerTextBox.Text.Trim(),
                            price: PriceNumeric.Value,
                            type: componentType,
                            stockQuantity: newStock,
                            createdAt: _component!.CreatedAt
                        );

                        PcbRepository.UpdateComponent(_component, transaction);

                        if (oldStock != newStock)
                        {
                            AdditionalRepository.CreateComponentStockMovement(_component.Id, oldStock, newStock, transaction);
                        }
                    }

                    if (_currentComponentType != ComponentType.Other)
                    {
                        SaveComponentSpecifications(_component.Id, transaction);
                    }
                });
                Utils.ShowInfoMessage("Данные сохранены успешно!");
                Close();
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при сохранении данных: {ex.Message}");
            }
        }

        private void SaveComponentSpecifications(int componentId, NpgsqlTransaction? transaction = null)
        {
            // Удаляем старые спецификации
            var oldSpecs = PcbRepository.GetComponentSpecifications(componentId, transaction);
            foreach (var spec in oldSpecs)
            {
                PcbRepository.DeleteComponentSpecification(spec.Id, transaction);
            }

            // Добавляем новые спецификации в зависимости от типа компонента
            switch (_currentComponentType)
            {
                case ComponentType.Resistor:
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.RESISTANCE,
                        FirstSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.TOLERANCE,
                        SecondSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.POWER,
                        ThirdSpecificationNumeric.Value.ToString()
                    ), transaction);
                    break;

                case ComponentType.Capacitor:
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.CAPACITANCE,
                        FirstSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.VOLTAGE,
                        SecondSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.MAX_TEMPERATURE,
                        ThirdSpecificationNumeric.Value.ToString()
                    ), transaction);
                    break;

                case ComponentType.Diode:
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.VOLTAGE_DROP,
                        FirstSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.REVERSE_VOLTAGE,
                        SecondSpecificationNumeric.Value.ToString()
                    ), transaction);
                    PcbRepository.AddComponentSpecification(new ComponentSpecification(
                        0, componentId, ComponentSpecification.FORWARD_CURRENT,
                        ThirdSpecificationNumeric.Value.ToString()
                    ), transaction);
                    break;
            }
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage() == DialogResult.Yes)
            {
                Close();
            }
        }

        private void AddQuantityButton_Click(object sender, EventArgs e)
        {
            StockQuantity.Value += AddQuantityNumeric.Value;
            AddQuantityNumeric.Value = 0;
        }

        private void TypeComboBox_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (TypeComboBox.SelectedItem != null)
            {
                string selectedType = TypeComboBox.SelectedItem.ToString()!;
                ComponentType componentType = MapComponentType(selectedType);
                ChangeSpecifications(componentType);
            }
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage("Вы уверены, что хотите удалить эту запись?") == DialogResult.Yes)
            {
                try
                {
                    Database.TransactionManager.ExecuteInTransaction(transaction =>
                    {
                        PcbRepository.DeleteComponentWithCleanup(_componentId!.Value, transaction);
                    });

                    Utils.ShowInfoMessage("Запись удалена успешно");
                    Close();
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении:\n{ex.Message}");
                }
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: EditOrderForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\EditOrderForm.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class EditOrderForm : Form
    {
        private int? _orderId;
        private bool _isEditMode;
        private BindingList<OrderItemDisplay> _orderItems;

        public EditOrderForm(int? orderId = null)
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            _orderId = orderId;
            _isEditMode = orderId.HasValue;

            InitializeDataGridView();
            LoadComboBoxes();

            if (_isEditMode)
            {
                LoadData(orderId!.Value);
                if (Settings.IsAdmin)
                {
                    DeleteButton.Visible = true;
                }
            }
            else
            {
                InitializeNewOrder();
            }
        }

        private void InitializeDataGridView()
        {
            // Настройка внешнего вида
            dataGridView1.AutoGenerateColumns = false;
            dataGridView1.AllowUserToAddRows = false;
            dataGridView1.AllowUserToDeleteRows = true;
            dataGridView1.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dataGridView1.MultiSelect = false;

            // Создание колонок
            var columns = new[]
            {
                new DataGridViewTextBoxColumn
                {
                    Name = "PcbName",
                    HeaderText = "Название платы",
                    DataPropertyName = "PcbName",
                    ReadOnly = true,
                    Width = 200
                },
                new DataGridViewTextBoxColumn
                {
                    Name = "Quantity",
                    HeaderText = "Количество",
                    DataPropertyName = "Quantity",
                    Width = 100
                },
                new DataGridViewTextBoxColumn
                {
                    Name = "PricePerPcb",
                    HeaderText = "Цена за шт., руб.",
                    DataPropertyName = "PricePerPcb",
                    Width = 120,
                    DefaultCellStyle = new DataGridViewCellStyle { Format = "N2" }
                },
                new DataGridViewTextBoxColumn
                {
                    Name = "TotalPrice",
                    HeaderText = "Сумма, руб.",
                    DataPropertyName = "TotalPrice",
                    ReadOnly = true,
                    Width = 120,
                    DefaultCellStyle = new DataGridViewCellStyle { Format = "N2" }
                }
            };

            dataGridView1.Columns.AddRange(columns);

            dataGridView1.CellEndEdit += DataGridView1_CellEndEdit;
            dataGridView1.UserDeletingRow += DataGridView1_UserDeletingRow;
            dataGridView1.DataError += DataGridView1_DataError;
        }

        private void LoadComboBoxes()
        {
            // Загрузка клиентов
            var clients = ClientRepository.GetAllClientsForComboBox();
            ClientComboBox.DataSource = clients;
            ClientComboBox.DisplayMember = "Name";
            ClientComboBox.ValueMember = "Id";

            // Загрузка статусов
            StatusComboBox.Items.AddRange(new object[]
            {
                "Не подтверждён",
                "Оплачен",
                "Готов",
                "Отправлен"
            });

            // Загрузка плат для добавления
            var pcbs = PcbRepository.GetAllPcbsForComboBox();
            PcbComboBox.DataSource = pcbs;
            PcbComboBox.DisplayMember = "Name";
            PcbComboBox.ValueMember = "Id";
        }

        private void LoadData(int orderId)
        {
            try
            {
                var order = OrderRepository.GetOrderById(orderId);
                if (order == null)
                {
                    Utils.ShowErrorMessage("Заказ не найден");
                    Close();
                    return;
                }

                // Заполняем основные данные заказа
                ClientComboBox.SelectedValue = order.ClientId;
                StatusComboBox.Text = order.Status;
                TotalAmountLabel.Text = order.TotalAmount?.ToString("N2") ?? "0";

                if (order.ShipmentDate.HasValue)
                {
                    ShipmentDatePicker.Value = order.ShipmentDate.Value;
                    ShipmentDateCheckBox.Checked = true;
                }

                TransportCompanyTextBox.Text = order.TransportCompany ?? "";

                // Загружаем предметы заказа в DataGridView
                LoadOrderItems(orderId);
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при загрузке данных: {ex.Message}");
                Close();
            }
        }

        private void LoadOrderItems(int orderId)
        {
            var orderItems = OrderRepository.GetOrderItems(orderId);
            _orderItems = new BindingList<OrderItemDisplay>();

            foreach (var orderItem in orderItems)
            {
                var pcb = PcbRepository.GetPcbById(orderItem.PcbId);
                if (pcb != null)
                {
                    _orderItems.Add(new OrderItemDisplay
                    {
                        Id = orderItem.Id,
                        PcbId = orderItem.PcbId,
                        PcbName = pcb.Name,
                        Quantity = orderItem.Quantity,
                        PricePerPcb = orderItem.PricePerPcb,
                        TotalPrice = orderItem.Quantity * orderItem.PricePerPcb
                    });
                }
            }

            dataGridView1.DataSource = _orderItems;
            UpdateTotalAmount();
        }

        private void InitializeNewOrder()
        {
            StatusComboBox.SelectedIndex = 0;
            _orderItems = new BindingList<OrderItemDisplay>();
            dataGridView1.DataSource = _orderItems;
            ShipmentDateCheckBox.Checked = false;
            ShipmentDatePicker.Enabled = false;
        }

        private void DataGridView1_CellEndEdit(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0 && e.ColumnIndex == dataGridView1.Columns["Quantity"].Index)
            {
                var row = dataGridView1.Rows[e.RowIndex];
                if (row.DataBoundItem is OrderItemDisplay item)
                {
                    // Валидация количества
                    if (item.Quantity <= 0)
                    {
                        Utils.ShowErrorMessage("Количество должно быть больше 0");
                        item.Quantity = 1;
                        dataGridView1.Refresh();
                    }

                    // Пересчет суммы
                    item.TotalPrice = item.Quantity * item.PricePerPcb;
                    dataGridView1.InvalidateRow(e.RowIndex);
                    UpdateTotalAmount();
                }
            }
        }

        private void DataGridView1_UserDeletingRow(object sender, DataGridViewRowCancelEventArgs e)
        {
            if (Utils.ShowQuestionMessage("Удалить выбранную позицию из заказа?") != DialogResult.Yes)
            {
                e.Cancel = true;
            }
        }

        private void DataGridView1_DataError(object sender, DataGridViewDataErrorEventArgs e)
        {
            Utils.ShowErrorMessage("Ошибка ввода данных. Проверьте правильность введенных значений");
            e.ThrowException = false;
        }

        private void UpdateTotalAmount()
        {
            decimal total = _orderItems.Sum(item => item.TotalPrice);
            TotalAmountLabel.Text = total.ToString("N2");
        }

        private void AddItemButton_Click(object sender, EventArgs e)
        {
            if (PcbComboBox.SelectedItem == null)
            {
                Utils.ShowErrorMessage("Выберите плату для добавления");
                return;
            }

            var selectedPcb = (PcbComboBox.SelectedItem as dynamic)?.Pcb;
            if (selectedPcb == null) return;

            // Проверяем, нет ли уже этой платы в заказе
            var existingItem = _orderItems.FirstOrDefault(item => item.PcbId == selectedPcb.Id);
            if (existingItem != null)
            {
                Utils.ShowErrorMessage("Эта плата уже есть в заказе. Измените количество в существующей строке");
                return;
            }

            var newItem = new OrderItemDisplay
            {
                PcbId = selectedPcb.Id,
                PcbName = selectedPcb.Name,
                Quantity = (int)QuantityNumeric.Value,
                PricePerPcb = selectedPcb.Price,
                TotalPrice = selectedPcb.Price
            };

            _orderItems.Add(newItem);
            dataGridView1.DataSource = new BindingList<OrderItemDisplay>(_orderItems);
            UpdateTotalAmount();
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            if (!ValidateData())
                return;

            try
            {
                Database.TransactionManager.ExecuteInTransaction(transaction =>
                {
                    // Получаем старые данные заказа для сравнения
                    List<OrderItem> oldOrderItems = new List<OrderItem>();
                    if (_isEditMode && _orderId.HasValue)
                    {
                        oldOrderItems = OrderRepository.GetOrderItems(_orderId.Value);
                    }

                    // Создаем/обновляем заказ
                    var order = new Order(
                        _orderId ?? 0,
                        (int)ClientComboBox.SelectedValue,
                        DateTime.Now,
                        StatusComboBox.Text,
                        decimal.Parse(TotalAmountLabel.Text),
                        ShipmentDateCheckBox.Checked ? ShipmentDatePicker.Value : (DateTime?)null,
                        TransportCompanyTextBox.Text
                    );

                    if (_isEditMode)
                    {
                        OrderRepository.UpdateOrder(order, transaction);
                    }
                    else
                    {
                        _orderId = OrderRepository.AddOrder(order, transaction);
                    }

                    // Обновляем остатки плат и сохраняем предметы заказа
                    UpdatePcbStocks(oldOrderItems, transaction);
                    SaveOrderItems(transaction);
                });

                Utils.ShowInfoMessage("Заказ сохранен успешно");
                Close();
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при сохранении заказа:\n{ex.Message}");
            }
        }

        private void UpdatePcbStocks(List<OrderItem> oldOrderItems, NpgsqlTransaction transaction)
        {
            if (!_orderId.HasValue) return;

            // Создаем словари для быстрого доступа
            var oldItemsDict = oldOrderItems.ToDictionary(item => item.PcbId, item => item);
            var newItemsDict = _orderItems.ToDictionary(item => item.PcbId, item => item);

            // Обрабатываем все платы, которые были или есть в заказе
            var allPcbIds = oldItemsDict.Keys.Union(newItemsDict.Keys).Distinct();

            foreach (var pcbId in allPcbIds)
            {
                int oldQuantity = oldItemsDict.ContainsKey(pcbId) ? oldItemsDict[pcbId].Quantity : 0;
                int newQuantity = newItemsDict.ContainsKey(pcbId) ? newItemsDict[pcbId].Quantity : 0;
                int quantityDifference = newQuantity - oldQuantity;

                if (quantityDifference != 0)
                {
                    UpdatePcbStock(pcbId, quantityDifference, transaction);
                }
            }
        }

        private void UpdatePcbStock(int pcbId, int quantityDifference, NpgsqlTransaction transaction)
        {
            var pcb = PcbRepository.GetPcbById(pcbId);
            if (pcb == null)
            {
                throw new Exception($"Плата с ID {pcbId} не найдена");
            }

            if (quantityDifference > pcb.TotalQuantity)
            {
                throw new Exception(
                    $"Недостаточно плат \"{pcb.Name}\" на складе для выполнения заказа.\n" +
                    $"Не хватает {quantityDifference - pcb.TotalQuantity} шт. плат");
            }

            int oldQuantity = pcb.TotalQuantity;
            pcb.TotalQuantity -= quantityDifference;

            PcbRepository.UpdatePcb(pcb, transaction);

            // Добавляем запись о движении при списании плат для заказа
            if (quantityDifference > 0)
            {
                AdditionalRepository.CreatePcbMovement("Списание", pcbId, quantityDifference,
                    $"Списание со склада {quantityDifference} плат \"{pcb.Name}\" для заказа", transaction);
            }
        }

        private void SaveOrderItems(NpgsqlTransaction transaction)
        {
            if (!_orderId.HasValue) return;

            // Удаляем старые позиции заказа
            OrderRepository.DeleteAllOrderItems(_orderId.Value, transaction);

            // Добавляем новые позиции
            foreach (var item in _orderItems)
            {
                var orderItem = new OrderItem(
                    id: 0,
                    orderId: _orderId.Value,
                    pcbId: item.PcbId,
                    quantity: item.Quantity,
                    pricePerPcb: item.PricePerPcb
                );

                OrderRepository.AddOrderItem(orderItem, transaction);
            }
        }

        private bool ValidateData()
        {
            if (ClientComboBox.SelectedValue == null)
            {
                Utils.ShowErrorMessage("Выберите клиента");
                return false;
            }

            if (string.IsNullOrEmpty(StatusComboBox.Text))
            {
                Utils.ShowErrorMessage("Выберите статус заказа");
                return false;
            }

            if (_orderItems.Count == 0)
            {
                Utils.ShowErrorMessage("Добавьте хотя бы одну позицию в заказ");
                return false;
            }

            // Проверяем, что все количества положительные
            foreach (var item in _orderItems)
            {
                if (item.Quantity <= 0)
                {
                    Utils.ShowErrorMessage($"Количество для платы '{item.PcbName}' должно быть больше 0");
                    return false;
                }
            }

            return true;
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage() == DialogResult.Yes)
            {
                Close();
            }
        }

        private void ShipmentDateCheckBox_CheckedChanged(object sender, EventArgs e)
        {
            ShipmentDatePicker.Enabled = ShipmentDateCheckBox.Checked;
            if (!ShipmentDateCheckBox.Checked)
            {
                ShipmentDatePicker.Value = DateTime.Now;
            }
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage("Вы уверены, что хотите удалить эту запись?") == DialogResult.Yes)
            {
                try
                {
                    Database.TransactionManager.ExecuteInTransaction(transaction =>
                    {
                        OrderRepository.DeleteOrderWithRestoreStock(_orderId!.Value, transaction);
                    });

                    Utils.ShowInfoMessage("Запись удалена успешно");
                    Close();
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении:\n{ex.Message}");
                }
            }
        }
    }

    class OrderItemDisplay
    {
        public int Id { get; set; }
        public int PcbId { get; set; }
        public string PcbName { get; set; }
        public int Quantity { get; set; }
        public decimal PricePerPcb { get; set; }
        public decimal TotalPrice { get; set; }
    }
}

// =============================================================================
// ФАЙЛ: EditPcbComponentForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\EditPcbComponentForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class EditPcbComponentForm : Form
    {
        private PcbComponent? _pcbComponent;
        private bool _isEditMode;
        private int _pcbId;
        private int? _componentId;

        public EditPcbComponentForm(int pcbId, int? componentId = null, string? componentName = null)
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            _isEditMode = componentId != null;
            _pcbId = pcbId;
            _componentId = componentId;

            if (_isEditMode)
            {
                ComponentComboBox.Enabled = false;
                ComponentComboBox.Text = componentName;
                LoadData(componentId!.Value);
                if (Settings.IsAdmin)
                {
                    DeleteButton.Visible = true;
                }
            }
            else
            {
                FillComboBox();
            }
        }

        private void LoadData(int componentId)
        {
            try
            {
                _pcbComponent = PcbRepository.GetPcbComponent(_pcbId, componentId);
                if (_pcbComponent == null)
                {
                    Utils.ShowErrorMessage("Не удалось загрузить компонент");
                    Close();
                }
                else
                {
                    CountNumeric.Value = _pcbComponent.ComponentCount;
                    CoordinatesTextBox.Text = _pcbComponent.Coordinates;
                }
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Не удалось загрузить компонент:\n{ex.Message}");
                Close();
            }
        }

        private void FillComboBox()
        {
            try
            {
                var components = PcbRepository.GetOtherComponentNames(_pcbId);
                foreach (var component in components)
                {
                    ComponentComboBox.Items.Add(component);
                }
                ComponentComboBox.DropDownStyle = ComboBoxStyle.DropDownList;
                if (ComponentComboBox.Items.Count > 0)
                {
                    ComponentComboBox.SelectedIndex = 0;
                }
                else
                {
                    Utils.ShowInfoMessage("На плате уже есть все доступные компоненты");
                    Close();
                }
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Не удалось загрузить имена компонентов:\n{ex.Message}");
                Close();
            }

        }

        private bool ValidateData()
        {
            return ComponentComboBox.Text != null;
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage() == DialogResult.Yes)
            {
                Close();
            }
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            if (!ValidateData())
            {
                Utils.ShowErrorMessage("Не заполнены все необходимые поля!");
                return;
            }
            try
            {
                Database.TransactionManager.ExecuteInTransaction(transaction =>
                {
                    var pcb = PcbRepository.GetPcbById(_pcbId);
                    int componentId = PcbRepository.GetComponentIdByName(ComponentComboBox.Text);
                    var component = PcbRepository.GetComponentById(componentId);
                    if (pcb == null)
                    {
                        throw new Exception("Не удалось получить плату компонента");
                    }
                    if (component == null)
                    {
                        throw new Exception("Не удалось получить компонент");
                    }

                    int oldStock = _pcbComponent == null ? 0 : _pcbComponent.ComponentCount;
                    _pcbComponent = new PcbComponent(_pcbId, _componentId.HasValue ? _componentId.Value :
                    PcbRepository.GetComponentIdByName(ComponentComboBox.Text),
                    Convert.ToInt32(CountNumeric.Value), CoordinatesTextBox.Text);

                    int newStock = _pcbComponent.ComponentCount;
                    int stockDifference = newStock - oldStock;
                    if (stockDifference != 0)
                    {
                        int componentStockDifference = stockDifference * pcb.TotalQuantity;
                        int oldComponentStock = component.StockQuantity;
                        component.StockQuantity -= componentStockDifference;

                        if (component.StockQuantity < 0)
                        {
                            throw new Exception($"Недостаточно компонентов на складе.\n" +
                            $"Не хватает {-component.StockQuantity} ед. компонента \"{component.Name}\"\n" +
                            $"Требуется для изменения: {componentStockDifference}, доступно: {oldComponentStock}");
                        }

                        PcbRepository.UpdateComponent(component, transaction);

                        // Добавляем запись о движении компонентов
                        if (componentStockDifference != 0)
                        {
                            string movementType = componentStockDifference > 0 ? "Списание" : "Поступление";
                            int movementQuantity = Math.Abs(componentStockDifference);
                            AdditionalRepository.CreateComponentMovement(movementType, componentId, movementQuantity,
                                $"{movementType.ToLower()} со склада {movementQuantity} компонентов \"{component.Name}\" для платы \"{pcb.Name}\"", transaction);
                        }
                    }

                    if (_isEditMode)
                    {
                        if (_pcbComponent == null)
                        {
                            Utils.ShowErrorMessage($"Ошибка при сохранении данных");
                            Close();
                        }
                        else
                        {
                            PcbRepository.UpdatePcbComponent(_pcbComponent, transaction);
                        }
                    }
                    else
                    {
                        if (_pcbComponent == null)
                        {
                            Utils.ShowErrorMessage($"Ошибка при сохранении данных");
                            Close();
                        }
                        else
                        {
                            PcbRepository.AddPcbComponent(_pcbComponent, transaction);
                        }
                    }
                });
                Utils.ShowInfoMessage("Данные сохранены успешно");
                Close();
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при сохранении данных: {ex.Message}");
            }
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage("Вы уверены, что хотите удалить эту запись?") == DialogResult.Yes)
            {
                try
                {
                    Database.TransactionManager.ExecuteInTransaction(transaction =>
                    {
                        PcbRepository.DeletePcbComponent(_pcbId, _componentId!.Value);
                    });

                    Utils.ShowInfoMessage("Запись удалена успешно");
                    Close();
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении:\n{ex.Message}");
                }
            }
        }
    }
}


// =============================================================================
// ФАЙЛ: EditPcbForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\EditPcbForm.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class EditPcbForm : Form
    {
        private int? _pcbId;
        private Pcb? _pcb;
        private bool _isEditMode;
        private string? _imagePath;

        public EditPcbForm(int? pcbId = null)
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            _pcbId = pcbId;
            _isEditMode = pcbId != null;

            if (_isEditMode)
            {
                LoadData();
                FillFields();
                if (Settings.IsAdmin)
                {
                    DeleteButton.Visible = true;
                }
            }
        }

        private void LoadData()
        {
            _pcb = PcbRepository.GetPcbById(_pcbId!.Value);
            if (_pcb == null)
            {
                Utils.ShowErrorMessage("Не удалось загрузить печатную плату");
                Close();
            }
        }

        private void FillFields()
        {
            if (_pcb != null)
            {
                NameTextBox.Text = _pcb.Name;
                SerialNumberTextBox.Text = _pcb.SerialNumber;
                BatchTextBox.Text = _pcb.Batch;
                DescriptionTextBox.Text = _pcb.Description;
                PriceNumeric.Value = _pcb.Price;
                TotalQuantity.Value = _pcb.TotalQuantity;
                ManufactureDatePicker.Value = _pcb.ManufactureDate ?? DateTime.Now;
                LengthNumeric.Value = _pcb.Length ?? 0;
                WidthNumeric.Value = _pcb.Width ?? 0;
                LayersNumeric.Value = _pcb.LayersCount ?? 0;
                CommentTextBox.Text = _pcb.Comment;
                if (_pcb.ImagePath != null && _pcb.ImagePath != "")
                {
                    PcbImage.ImageLocation = _pcb.ImagePath;
                }
            }
            else
            {
                Utils.ShowErrorMessage("Не удалось загрузить печатную плату");
                Close();
            }
        }

        private bool ValidateData()
        {
            return (NameTextBox.Text != "") && (SerialNumberTextBox.Text != "");
        }

        private void SaveButton_Click(object sender, EventArgs e)
        {
            if (!ValidateData())
            {
                Utils.ShowErrorMessage("Не заполнены необходимые поля!");
                return;
            }

            try
            {
                Database.TransactionManager.ExecuteInTransaction(transaction =>
                {
                    if (!_isEditMode)
                    {
                        _pcbId = 0;
                    }

                    int oldStock = _isEditMode ? _pcb!.TotalQuantity : 0;
                    int newStock = (int)TotalQuantity.Value;
                    int stockDifference = newStock - oldStock;

                    if (_isEditMode && stockDifference != 0)
                    {
                        UpdateComponentStocks(_pcbId!.Value, stockDifference, transaction);
                    }

                    _pcb = new Pcb(
                        _pcbId!.Value, NameTextBox.Text, SerialNumberTextBox.Text,
                        BatchTextBox.Text, DescriptionTextBox.Text, PriceNumeric.Value,
                        newStock, ManufactureDatePicker.Value,
                        LengthNumeric.Value, WidthNumeric.Value, (int)LayersNumeric.Value,
                        CommentTextBox.Text, _imagePath
                    );

                    if (_isEditMode)
                    {
                        PcbRepository.UpdatePcb(_pcb, transaction);

                        if (stockDifference != 0)
                        {
                            AdditionalRepository.CreatePcbStockMovement(_pcb.Id, oldStock, newStock, transaction);
                        }
                    }
                    else
                    {
                        _pcb.Id = PcbRepository.AddPcb(_pcb, transaction);
                        
                        if (newStock > 0)
                        {
                            AdditionalRepository.CreatePcbMovement("Поступление", _pcb.Id, newStock,
                                $"Поступление на склад {newStock} плат \"{_pcb.Name}\"", transaction);
                        }
                    }
                });
                Utils.ShowInfoMessage("Данные были сохранены успешно");
                Close();
            }
            catch (Exception ex)
            {
                Utils.ShowErrorMessage($"Ошибка при сохранении данных: {ex.Message}");
            }
        }

        private void UpdateComponentStocks(int pcbId, int stockDifference, NpgsqlTransaction transaction)
        {
            var pcbComponents = PcbRepository.GetPcbComponents(pcbId, transaction);

            foreach (var pcbComponent in pcbComponents)
            {
                var component = PcbRepository.GetComponentById(pcbComponent.ComponentId, transaction);
                if (component == null)
                {
                    throw new Exception($"Компонент с ID {pcbComponent.ComponentId} не найден");
                }

                int componentStockDifference = stockDifference * pcbComponent.ComponentCount;
                int newComponentStock = component.StockQuantity - componentStockDifference;

                if (newComponentStock < 0)
                {
                    throw new Exception(
                        $"Недостаточно компонентов на складе.\n" +
                        $"Не хватает {-newComponentStock} ед. компонента \"{component.Name}\"\n" +
                        $"Требуется для изменения: {componentStockDifference}, доступно: {component.StockQuantity}");
                }

                component.StockQuantity = newComponentStock;

                PcbRepository.UpdateComponent(component, transaction);
            }
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage() == DialogResult.Yes)
            {
                Close();
            }
        }

        private void AddQuantityButton_Click(object sender, EventArgs e)
        {
            TotalQuantity.Value += AddQuantityNumeric.Value;
            AddQuantityNumeric.Value = 0;
        }

        private void PcbImage_Click(object sender, EventArgs e)
        {
            using (OpenFileDialog openFileDialog = new OpenFileDialog())
            {
                openFileDialog.Title = "Выберите изображение печатной платы";
                openFileDialog.Filter = "Изображения (*.jpg; *.jpeg; *.png; *.bmp; *.gif)|*.jpg; *.jpeg; *.png; *.bmp; *.gif|Все файлы (*.*)|*.*";
                openFileDialog.FilterIndex = 1;
                openFileDialog.RestoreDirectory = true;
                openFileDialog.Multiselect = false;

                openFileDialog.CheckFileExists = true;
                openFileDialog.CheckPathExists = true;
                openFileDialog.ValidateNames = true;

                if (openFileDialog.ShowDialog() == DialogResult.OK)
                {
                    try
                    {
                        _imagePath = openFileDialog.FileName;

                        PcbImage.Image?.Dispose();
                        PcbImage.Image = Image.FromFile(_imagePath);
                    }
                    catch (Exception ex)
                    {
                        Utils.ShowErrorMessage($"Не удалось загрузить изображение:\n{ex.Message}");
                        _imagePath = null;
                        PcbImage.Image = Properties.Resources.circuit_placeholder;
                    }
                }
            }
        }

        private void ComponentsButton_Click(object sender, EventArgs e)
        {
            new ComponentsListForm(_pcbId).ShowDialog();
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage("Вы уверены, что хотите удалить эту запись?") == DialogResult.Yes)
            {
                try
                {
                    Database.TransactionManager.ExecuteInTransaction(transaction =>
                    {
                        PcbRepository.DeletePcbWithComponents(_pcbId!.Value, transaction);
                    });

                    Utils.ShowInfoMessage("Запись удалена успешно");
                    Close();
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении:\n{ex.Message}");
                }
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: Entities.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\Entities.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    // Существующие классы (оставляем как есть)
    public class Client
    {
        public int Id { get; set; }
        public string Type { get; set; }
        public string? Phone { get; set; }
        public string? Email { get; set; }
        public string Inn { get; set; }

        public Client(int id, string type, string phone, string email, string inn)
        {
            Id = id;
            Type = type;
            Phone = phone;
            Email = email;
            Inn = inn;
        }
    }

    public class Individual
    {
        public int ClientId { get; set; }
        public string FullName { get; set; }
        public string? Address { get; set; }
        public int? Age { get; set; }

        public Individual(int clientId, string fullName, string address, int age)
        {
            ClientId = clientId;
            FullName = fullName;
            Address = address;
            Age = age;
        }
    }

    public class LegalEntity
    {
        public int ClientId { get; set; }
        public string CompanyName { get; set; }
        public string? ContactPerson { get; set; }
        public string? LegalAddress { get; set; }
        public string? ActualAddress { get; set; }

        public LegalEntity(int clientId, string companyName, string contactPerson, string legalAddress, string actualAddress)
        {
            ClientId = clientId;
            CompanyName = companyName;
            ContactPerson = contactPerson;
            LegalAddress = legalAddress;
            ActualAddress = actualAddress;
        }
    }

    // Новые сущности для остальных таблиц

    public class Employee
    {
        public int Id { get; set; }
        public string FullName { get; set; }
        public string? Address { get; set; }
        public string? Phone { get; set; }
        public string? Email { get; set; }
        public string? Position { get; set; }
        public decimal? Salary { get; set; }
        public string Login { get; set; }
        public string PasswordHash { get; set; }
        public DateTime CreatedAt { get; set; }

        public Employee(int id, string fullName, string address, string phone, string email,
                       string position, decimal salary, string login, string passwordHash, DateTime createdAt)
        {
            Id = id;
            FullName = fullName;
            Address = address;
            Phone = phone;
            Email = email;
            Position = position;
            Salary = salary;
            Login = login;
            PasswordHash = passwordHash;
            CreatedAt = createdAt;
        }
    }

    public class Pcb
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string SerialNumber { get; set; }
        public string? Batch { get; set; }
        public string? Description { get; set; }
        public decimal Price { get; set; }
        public int TotalQuantity { get; set; }
        public DateTime? ManufactureDate { get; set; }
        public decimal? Length { get; set; }
        public decimal? Width { get; set; }
        public int? LayersCount { get; set; }
        public string? Comment { get; set; }
        public string? ImagePath { get; set; }

        public Pcb(int id, string name, string serialNumber, string? batch, string? description,
                  decimal price, int totalQuantity, DateTime? manufactureDate,
                  decimal? length, decimal? width, int? layersCount, string? comment, string? imagePath)
        {
            Id = id;
            Name = name;
            SerialNumber = serialNumber;
            Batch = batch;
            Description = description;
            Price = price;
            TotalQuantity = totalQuantity;
            ManufactureDate = manufactureDate;
            Length = length;
            Width = width;
            LayersCount = layersCount;
            Comment = comment;
            ImagePath = imagePath;
        }
    }

    public class Component
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string? Manufacturer { get; set; }
        public decimal Price { get; set; }
        public string Type { get; set; }
        public int StockQuantity { get; set; }
        public DateTime CreatedAt { get; set; }

        public Component(int id, string name, string? manufacturer, decimal price,
                        string type, int stockQuantity, DateTime createdAt)
        {
            Id = id;
            Name = name;
            Manufacturer = manufacturer;
            Price = price;
            Type = type;
            StockQuantity = stockQuantity;
            CreatedAt = createdAt;
        }
    }

    // Добавьте в Entities.cs
    public class ComponentSpecification
    {
        // Константы для типов спецификаций
        public const string RESISTANCE = "Сопротивление";
        public const string TOLERANCE = "Допуск";
        public const string POWER = "Мощность";
        public const string CAPACITANCE = "Ёмкость";
        public const string VOLTAGE = "Напряжение";
        public const string MAX_TEMPERATURE = "Максимальная температура";
        public const string VOLTAGE_DROP = "Падение напряжения";
        public const string REVERSE_VOLTAGE = "Обратное напряжение";
        public const string FORWARD_CURRENT = "Прямой ток";

        public int Id { get; set; }
        public int ComponentId { get; set; }
        public string Specification { get; set; }
        public string SpecificationValue { get; set; }

        public ComponentSpecification(int id, int componentId, string specification, string specificationValue)
        {
            Id = id;
            ComponentId = componentId;
            Specification = specification;
            SpecificationValue = specificationValue;
        }
    }

    public class PcbComponent
    {
        public int PcbId { get; set; }
        public int ComponentId { get; set; }
        public int ComponentCount { get; set; }
        public string? Coordinates { get; set; }

        public PcbComponent(int pcbId, int componentId, int componentCount, string? coordinates)
        {
            PcbId = pcbId;
            ComponentId = componentId;
            ComponentCount = componentCount;
            Coordinates = coordinates;
        }
    }

    public class Order
    {
        public int Id { get; set; }
        public int ClientId { get; set; }
        public DateTime RegistrationDate { get; set; }
        public string Status { get; set; }
        public decimal? TotalAmount { get; set; }
        public DateTime? ShipmentDate { get; set; }
        public string? TransportCompany { get; set; }

        public Order(int id, int clientId, DateTime registrationDate, string status,
                    decimal totalAmount, DateTime? shipmentDate, string? transportCompany)
        {
            Id = id;
            ClientId = clientId;
            RegistrationDate = registrationDate;
            Status = status;
            TotalAmount = totalAmount;
            ShipmentDate = shipmentDate;
            TransportCompany = transportCompany;
        }
    }

    public class OrderItem
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public int PcbId { get; set; }
        public int Quantity { get; set; }
        public decimal PricePerPcb { get; set; }

        public OrderItem(int id, int orderId, int pcbId, int quantity, decimal pricePerPcb)
        {
            Id = id;
            OrderId = orderId;
            PcbId = pcbId;
            Quantity = quantity;
            PricePerPcb = pricePerPcb;
        }
    }

    public class Movement
    {
        public int Id { get; set; }
        public string MovementType { get; set; }
        public string ProductType { get; set; }
        public string? Description { get; set; }
        public int Value { get; set; }
        public DateTime MovementDate { get; set; }

        public Movement(int id, string movementType, string productType, string? description,
                       int value, DateTime movementDate)
        {
            Id = id;
            MovementType = movementType;
            ProductType = productType;
            Description = description;
            Value = value;
            MovementDate = movementDate;
        }
    }

    public enum ComponentType
    {
        Resistor,
        Capacitor,
        Diode,
        Transistor,
        Microcontroller,
        Other
    }
}

// =============================================================================
// ФАЙЛ: MainForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\MainForm.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Security.Policy;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class MainForm : Form
    {
        public MainForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);
        }

        private void PcbsButton_Click(object sender, EventArgs e)
        {
            new PcbsListForm().ShowDialog();
        }

        private void ClientsButton_Click(object sender, EventArgs e)
        {
            new ClientsListForm().ShowDialog();
        }

        private void ComponentsButton_Click(object sender, EventArgs e)
        {
            new ComponentsListForm().ShowDialog();
        }

        private void OrdersButton_Click(object sender, EventArgs e)
        {
            new OrdersListForm().ShowDialog();
        }

        private void MovementsButton_Click(object sender, EventArgs e)
        {
            new MovementsListForm().ShowDialog();
        }

        private void ExitButton_Click(object sender, EventArgs e)
        {
            Application.Exit();
        }
    }
}


// =============================================================================
// ФАЙЛ: MovementCard.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\MovementCard.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Xml;

namespace ElectronicsFactory
{
    public partial class MovementCard : UserControl
    {
        public int Id { get; set; }

        public MovementCard(MovementCardInfo info)
        {
            InitializeComponent();

            Id = info.Id;
            TypeLabel.Text = info.Type;
            DescriptionLabel.Text = info.Description ?? "Описание отсутствует";
            DateLabel.Text = info.Date.ToString();

            SettingsUI.StyleCard(this);
        }
    }
}


// =============================================================================
// ФАЙЛ: MovementsListForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\MovementsListForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class MovementsListForm : Form
    {
        private int _pageSize = 4;
        private int _currentPage = 1;
        private int _totalPages = 1;
        private string _currentTypeFilter = "Все";
        private Label _noResultsLabel;

        public MovementsListForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            InitializeNoResultsLabel();
            LoadTypeFilterComboBox();
            LoadMovementsPage();
            UpdatePaginationButtons();
            DeletionGroupBox.Visible = Settings.IsAdmin;
        }

        private void InitializeNoResultsLabel()
        {
            _noResultsLabel = new Label();
            _noResultsLabel.Text = "Движений нет";
            _noResultsLabel.AutoSize = true;
            _noResultsLabel.Font = new Font("Times New Roman", 12F, FontStyle.Italic, GraphicsUnit.Point, 204);
            _noResultsLabel.ForeColor = Color.Gray;
            _noResultsLabel.Visible = false;
            flowLayoutPanel1.Controls.Add(_noResultsLabel);
        }

        private void LoadTypeFilterComboBox()
        {
            TypeComboBox.Items.AddRange(new object[] { "Все", "Поступление", "Списание" });
            TypeComboBox.SelectedItem = "Все";
        }

        private void LoadMovementsPage()
        {
            flowLayoutPanel1.Controls.Clear();
            flowLayoutPanel1.Controls.Add(_noResultsLabel);

            var movements = AdditionalRepository.GetMovementsPage(_pageSize, _currentPage, _currentTypeFilter);
            long totalMovements = AdditionalRepository.GetTotalMovementsCount(_currentTypeFilter);
            _totalPages = (int)Math.Ceiling((double)totalMovements / _pageSize);

            if (_totalPages == 0) _totalPages = 1;

            if (movements.Count == 0)
            {
                _noResultsLabel.Visible = true;
            }
            else
            {
                _noResultsLabel.Visible = false;

                foreach (var info in movements)
                {
                    var card = new MovementCard(info);
                    flowLayoutPanel1.Controls.Add(card);
                }
            }

            UpdatePageInfo();
            UpdatePaginationButtons();
        }

        private void UpdatePageInfo()
        {
            PageLabel.Text = $"Страница {_currentPage} из {_totalPages}";
        }

        private void UpdatePaginationButtons()
        {
            PrevButton.Enabled = _currentPage > 1;
            NextButton.Enabled = _currentPage < _totalPages;
        }

        private void PrevPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                LoadMovementsPage();
            }
        }

        private void NextPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                LoadMovementsPage();
            }
        }

        private void FilterButton_Click(object sender, EventArgs e)
        {
            _currentTypeFilter = TypeComboBox.SelectedItem?.ToString() ?? "Все";
            _currentPage = 1;
            LoadMovementsPage();
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void DeleteButton_Click(object sender, EventArgs e)
        {
            if (Utils.ShowQuestionMessage($"Вы уверены, что хотите удалить все движения с {StartDatePicker.Value:dd.MM.yyyy} по {EndDatePicker.Value:dd.MM.yyyy}?") == DialogResult.Yes)
            {
                try
                {
                    int deletedCount = AdditionalRepository.DeleteMovementsInPeriod(
                        StartDatePicker.Value,
                        EndDatePicker.Value.AddDays(1).AddSeconds(-1)
                    );

                    LoadMovementsPage();
                    Utils.ShowInfoMessage($"Удалено движений: {deletedCount}");
                }
                catch (Exception ex)
                {
                    Utils.ShowErrorMessage($"Ошибка при удалении движений:\n{ex.Message}");
                }
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: obj/Debug/net8.0-windows/.NETCoreApp,Version=v8.0.AssemblyAttributes.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\obj\Debug\net8.0-windows\.NETCoreApp,Version=v8.0.AssemblyAttributes.cs
// =============================================================================

// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v8.0", FrameworkDisplayName = ".NET 8.0")]


// =============================================================================
// ФАЙЛ: obj/Debug/net8.0-windows/ElectronicsFactory.GlobalUsings.g.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\obj\Debug\net8.0-windows\ElectronicsFactory.GlobalUsings.g.cs
// =============================================================================

// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.Drawing;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
global using global::System.Windows.Forms;


// =============================================================================
// ФАЙЛ: OrderCard.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\OrderCard.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Xml;

namespace ElectronicsFactory
{
    public partial class OrderCard : UserControl
    {
        public int Id { get; set; }

        public OrderCard(OrderCardInfo info)
        {
            InitializeComponent();

            Id = info.Id;
            ClientLabel.Text = $"Заказчик: {info.Client}";
            StatusLabel.Text = $"Статус: {info.Status}";
            TotalAmountLabel.Text = $"Стоимость плат: {info.TotalAmount} руб.";
            RegistrationDateLabel.Text = $"Дата регистрации: {info.RegistrationDate}";
            ShipmentDateLabel.Text = info.ShipmentDate != null ?
                $"Дата отгрузки: {info.ShipmentDate}" : "Дата отгрузки отсутствует";

            SettingsUI.StyleCard(this);
        }

        private void Card_Click(object sender, EventArgs e)
        {
            OnClick(e);
        }
    }
}


// =============================================================================
// ФАЙЛ: OrderRepository.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\OrderRepository.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace ElectronicsFactory
{
    public static class OrderRepository
    {
        // ========== ORDER METHODS ==========

        public static List<OrderCardInfo> GetOrdersPage(int pageSize, int pageNumber,
            string? clientFilter = null, string? statusFilter = null, string? dateFilter = null)
        {
            int offset = (pageNumber - 1) * pageSize;

            // SQL с JOIN для получения имени клиента
            string sql = @"
                SELECT 
                    o.id,
                    o.status,
                    o.total_amount,
                    o.registration_date,
                    o.shipment_date,
                    COALESCE(i.full_name, le.company_name) as client_name
                FROM orders o
                LEFT JOIN clients c ON o.client_id = c.id
                LEFT JOIN individuals i ON c.id = i.client_id
                LEFT JOIN legal_entities le ON c.id = le.client_id
                WHERE 1=1";

            var parameters = new List<NpgsqlParameter>
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            // Фильтр по клиенту (поиск по имени/названию компании)
            if (!string.IsNullOrEmpty(clientFilter))
            {
                sql += @" AND (COALESCE(i.full_name, le.company_name) ILIKE @clientFilter)";
                parameters.Add(new NpgsqlParameter("@clientFilter", $"%{clientFilter}%"));
            }

            // Фильтр по статусу
            if (!string.IsNullOrEmpty(statusFilter) && statusFilter != "Все")
            {
                sql += " AND o.status = @statusFilter";
                parameters.Add(new NpgsqlParameter("@statusFilter", statusFilter));
            }

            // Сортировка в зависимости от dateFilter
            sql += dateFilter switch
            {
                "По дате регистрации" => " ORDER BY o.registration_date DESC",
                "По дате отгрузки" => @" ORDER BY 
                                CASE WHEN o.shipment_date IS NULL THEN 1 ELSE 0 END,
                                o.shipment_date DESC",
                _ => " ORDER BY o.id DESC" // "По умолчанию" или любой другой случай
            };

            sql += " LIMIT @limit OFFSET @offset";

            var dataTable = Database.ExecuteDataTable(sql, parameters.ToArray());
            return DataTableToOrderCardInfoList(dataTable);
        }

        private static List<OrderCardInfo> DataTableToOrderCardInfoList(DataTable dataTable)
        {
            var orders = new List<OrderCardInfo>();
            foreach (DataRow row in dataTable.Rows)
            {
                orders.Add(DataRowToOrderCardInfo(row));
            }
            return orders;
        }

        private static OrderCardInfo DataRowToOrderCardInfo(DataRow row)
        {
            return new OrderCardInfo(
                id: Convert.ToInt32(row["id"]),
                client: row["client_name"].ToString() ?? "Неизвестный клиент",
                status: row["status"].ToString() ?? "",
                totalAmount: row["total_amount"] == DBNull.Value ? 0 : Convert.ToDouble(row["total_amount"]),
                registrationDate: Convert.ToDateTime(row["registration_date"]),
                shipmentDate: row["shipment_date"] == DBNull.Value ? null : Convert.ToDateTime(row["shipment_date"])
            );
        }

        public static long GetTotalOrdersCount(string? clientFilter = null, string? statusFilter = null)
        {
            string sql = @"
        SELECT COUNT(*) 
        FROM orders o
        LEFT JOIN clients c ON o.client_id = c.id
        LEFT JOIN individuals i ON c.id = i.client_id
        LEFT JOIN legal_entities le ON c.id = le.client_id
        WHERE 1=1";

            var parameters = new List<NpgsqlParameter>();

            // Фильтр по клиенту (поиск по имени/названию компании)
            if (!string.IsNullOrEmpty(clientFilter))
            {
                sql += @" AND (COALESCE(i.full_name, le.company_name) ILIKE @clientFilter)";
                parameters.Add(new NpgsqlParameter("@clientFilter", $"%{clientFilter}%"));
            }

            // Фильтр по статусу
            if (!string.IsNullOrEmpty(statusFilter) && statusFilter != "Все")
            {
                sql += " AND o.status = @statusFilter";
                parameters.Add(new NpgsqlParameter("@statusFilter", statusFilter));
            }

            return Database.ExecuteScalar<long>(sql, parameters.ToArray());
        }

        public static Order? GetOrderById(int id)
        {
            string sql = "SELECT * FROM orders WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            return DataRowToOrder(dataTable.Rows[0]);
        }

        public static List<Order> GetOrdersByClientId(int clientId)
        {
            string sql = "SELECT * FROM orders WHERE client_id = @clientId ORDER BY registration_date DESC";
            var parameters = new[] { new NpgsqlParameter("@clientId", clientId) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            return DataTableToOrderList(dataTable);
        }

        public static List<Order> GetOrdersByStatus(string status)
        {
            string sql = "SELECT * FROM orders WHERE status = @status ORDER BY registration_date DESC";
            var parameters = new[] { new NpgsqlParameter("@status", status) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            return DataTableToOrderList(dataTable);
        }

        public static int AddOrder(Order order, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO orders (client_id, registration_date, status, total_amount, 
                          shipment_date, transport_company)
                          VALUES (@clientId, @registrationDate, @status, @totalAmount, 
                          @shipmentDate, @transportCompany)
                          RETURNING id";

            var parameters = new[]
            {
                new NpgsqlParameter("@clientId", order.ClientId),
                new NpgsqlParameter("@registrationDate", order.RegistrationDate),
                new NpgsqlParameter("@status", order.Status),
                new NpgsqlParameter("@totalAmount", order.TotalAmount ?? (object)DBNull.Value),
                new NpgsqlParameter("@shipmentDate", order.ShipmentDate ?? (object)DBNull.Value),
                new NpgsqlParameter("@transportCompany", order.TransportCompany ?? (object)DBNull.Value)
            };

            if (transaction == null)
            {
                return Database.ExecuteScalar<int>(sql, parameters);
            }
            else
            {
                return Database.ExecuteScalar<int>(sql, transaction, parameters);
            }
        }

        public static void UpdateOrder(Order order, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE orders SET client_id = @clientId, registration_date = @registrationDate, 
                          status = @status, total_amount = @totalAmount, shipment_date = @shipmentDate, 
                          transport_company = @transportCompany 
                          WHERE id = @id";

            var parameters = new[]
            {
                new NpgsqlParameter("@clientId", order.ClientId),
                new NpgsqlParameter("@registrationDate", order.RegistrationDate),
                new NpgsqlParameter("@status", order.Status),
                new NpgsqlParameter("@totalAmount", order.TotalAmount ?? (object)DBNull.Value),
                new NpgsqlParameter("@shipmentDate", order.ShipmentDate ?? (object)DBNull.Value),
                new NpgsqlParameter("@transportCompany", order.TransportCompany ?? (object)DBNull.Value),
                new NpgsqlParameter("@id", order.Id)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteOrder(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM orders WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdateOrderStatus(int orderId, string status)
        {
            string sql = "UPDATE orders SET status = @status WHERE id = @id";
            var parameters = new[]
            {
                new NpgsqlParameter("@status", status),
                new NpgsqlParameter("@id", orderId)
            };

            Database.ExecuteNonQuery(sql, parameters);
        }

        public static void DeleteOrderWithRestoreStock(int orderId, NpgsqlTransaction? transaction = null)
        {
            var order = GetOrderById(orderId);
            if (order == null) return;

            var orderItems = GetOrderItems(orderId);

            foreach (var item in orderItems)
            {
                var pcb = PcbRepository.GetPcbById(item.PcbId);
                if (pcb != null)
                {
                    pcb.TotalQuantity += item.Quantity;
                    PcbRepository.UpdatePcb(pcb, transaction);

                    // Запись о движении - возврат плат
                    AdditionalRepository.CreatePcbMovement("Поступление",
                        pcb.Id, item.Quantity,
                        $"Возврат плат после удаления заказа №{orderId}",
                        transaction);
                }
            }

            DeleteAllOrderItems(orderId, transaction);
            DeleteOrder(orderId, transaction);
        }

        // ========== ORDER ITEM METHODS ==========

        public static List<OrderItem> GetOrderItems(int orderId)
        {
            string sql = "SELECT * FROM order_items WHERE order_id = @orderId";
            var parameters = new[] { new NpgsqlParameter("@orderId", orderId) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            return DataTableToOrderItemList(dataTable);
        }

        public static DataTable GetOrderItemsDataTable(int orderId)
        {
            string sql = "SELECT * FROM order_items WHERE order_id = @orderId";
            var parameters = new[] { new NpgsqlParameter("@orderId", orderId) };

            return Database.ExecuteDataTable(sql, parameters);
        }

        public static void AddOrderItem(OrderItem orderItem, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO order_items (order_id, pcb_id, quantity, price_per_pcb)
                          VALUES (@orderId, @pcbId, @quantity, @pricePerPcb)";

            var parameters = new[]
            {
                new NpgsqlParameter("@orderId", orderItem.OrderId),
                new NpgsqlParameter("@pcbId", orderItem.PcbId),
                new NpgsqlParameter("@quantity", orderItem.Quantity),
                new NpgsqlParameter("@pricePerPcb", orderItem.PricePerPcb)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdateOrderItem(OrderItem orderItem)
        {
            string sql = @"UPDATE order_items SET quantity = @quantity, price_per_pcb = @pricePerPcb
                          WHERE id = @id";

            var parameters = new[]
            {
                new NpgsqlParameter("@quantity", orderItem.Quantity),
                new NpgsqlParameter("@pricePerPcb", orderItem.PricePerPcb),
                new NpgsqlParameter("@id", orderItem.Id)
            };

            Database.ExecuteNonQuery(sql, parameters);
        }

        public static void DeleteOrderItem(int id)
        {
            string sql = "DELETE FROM order_items WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };
            Database.ExecuteNonQuery(sql, parameters);
        }

        public static void DeleteAllOrderItems(int orderId, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM order_items WHERE order_id = @orderId";
            var parameters = new[] { new NpgsqlParameter("@orderId", orderId) };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        // ========== HELPER METHODS ==========

        private static List<Order> DataTableToOrderList(DataTable dataTable)
        {
            var orders = new List<Order>();
            foreach (DataRow row in dataTable.Rows)
            {
                orders.Add(DataRowToOrder(row));
            }
            return orders;
        }

        private static Order DataRowToOrder(DataRow row)
        {
            return new Order(
                id: Convert.ToInt32(row["id"]),
                clientId: Convert.ToInt32(row["client_id"]),
                registrationDate: Convert.ToDateTime(row["registration_date"]),
                status: row["status"].ToString() ?? "",
                totalAmount: Convert.ToDecimal(row["total_amount"]),
                shipmentDate: row["shipment_date"] == DBNull.Value ? null : Convert.ToDateTime(row["shipment_date"]),
                transportCompany: row["transport_company"]?.ToString()
            );
        }

        private static List<OrderItem> DataTableToOrderItemList(DataTable dataTable)
        {
            var orderItems = new List<OrderItem>();
            foreach (DataRow row in dataTable.Rows)
            {
                orderItems.Add(new OrderItem(
                    id: Convert.ToInt32(row["id"]),
                    orderId: Convert.ToInt32(row["order_id"]),
                    pcbId: Convert.ToInt32(row["pcb_id"]),
                    quantity: Convert.ToInt32(row["quantity"]),
                    pricePerPcb: Convert.ToDecimal(row["price_per_pcb"])
                ));
            }
            return orderItems;
        }
    }
}

// =============================================================================
// ФАЙЛ: OrdersListForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\OrdersListForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class OrdersListForm : Form
    {
        private int _pageSize = 3;
        private int _currentPage = 1;
        private int _totalPages = 1;
        private string _currentClientFilter = "";
        private string _currentStatusFilter = "Все";
        private string _currentDateFilter = "По умолчанию";
        private Label _noResultsLabel;

        public OrdersListForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            InitializeNoResultsLabel();
            LoadOrdersPage();
            UpdatePaginationButtons();
        }

        private void InitializeNoResultsLabel()
        {
            _noResultsLabel = new Label();
            _noResultsLabel.Text = "Заказы не найдены";
            _noResultsLabel.AutoSize = true;
            _noResultsLabel.Font = new Font("Times New Roman", 12F, FontStyle.Italic, GraphicsUnit.Point, 204);
            _noResultsLabel.ForeColor = Color.Gray;
            _noResultsLabel.Visible = false;
            flowLayoutPanel1.Controls.Add(_noResultsLabel);
        }

        private void LoadOrdersPage()
        {
            flowLayoutPanel1.Controls.Clear();
            flowLayoutPanel1.Controls.Add(_noResultsLabel);

            var orders = OrderRepository.GetOrdersPage(_pageSize, _currentPage,
                _currentClientFilter, _currentStatusFilter, _currentDateFilter);
            long totalOrders = OrderRepository.GetTotalOrdersCount(_currentClientFilter, _currentStatusFilter);
            _totalPages = (int)Math.Ceiling((double)totalOrders / _pageSize);

            if (_totalPages == 0) _totalPages = 1;

            if (orders.Count == 0)
            {
                _noResultsLabel.Visible = true;
            }
            else
            {
                _noResultsLabel.Visible = false;

                foreach (var info in orders)
                {
                    var card = new OrderCard(info);
                    card.Click += Card_Click!;
                    flowLayoutPanel1.Controls.Add(card);
                }
            }

            UpdatePageInfo();
            UpdatePaginationButtons();
        }

        private void Card_Click(object sender, EventArgs e)
        {
            var card = (OrderCard)sender;
            new EditOrderForm(card.Id).ShowDialog();
            LoadOrdersPage();
        }

        private void UpdatePageInfo()
        {
            PageLabel.Text = $"Страница {_currentPage} из {_totalPages}";
        }

        private void UpdatePaginationButtons()
        {
            PrevButton.Enabled = _currentPage > 1;
            NextButton.Enabled = _currentPage < _totalPages;
        }

        private void PrevPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                LoadOrdersPage();
            }
        }

        private void NextPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                LoadOrdersPage();
            }
        }

        private void AddOrderButton_Click(object sender, EventArgs e)
        {
            new EditOrderForm().ShowDialog();
            LoadOrdersPage();
        }

        private void FilterButton_Click(object sender, EventArgs e)
        {
            _currentClientFilter = ClientFilterTextBox.Text.Trim();
            _currentStatusFilter = StatusFilterComboBox.Text.Trim();
            _currentDateFilter = DateFilterComboBox.Text.Trim();

            _currentPage = 1;

            LoadOrdersPage();
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void NameFilterTextBox_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                FilterButton_Click(sender, e);
                e.Handled = true;
            }
        }
    }
}


// =============================================================================
// ФАЙЛ: PcbCard.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\PcbCard.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class PcbCard : UserControl
    {
        public int Id { get; set; }
        public PcbCard(PcbCardInfo info)
        {
            InitializeComponent();

            Id = info.Id;
            NameLabel.Text = info.Name;
            DescriptionLabel.Text = info.Description != "" ? info.Description : "Описание отсутствует";
            PriceLabel.Text = $"Стоимость: {info.Price} руб.";
            QuantityLabel.Text = $"Всего на складе: {info.Quantity} шт.";
            if (info.ImagePath != null && info.ImagePath != "")
            {
                PcbImage.ImageLocation = info.ImagePath;
            }
            else
            {
                PcbImage.Image = Properties.Resources.circuit_placeholder;
            }

            SettingsUI.StyleCard(this);
        }

        private void Card_Click(object sender, EventArgs e)
        {
            OnClick(e);
        }
    }
}


// =============================================================================
// ФАЙЛ: PcbRepository.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\PcbRepository.cs
// =============================================================================

using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace ElectronicsFactory
{
    public static class PcbRepository
    {
        // ========== PCB METHODS ==========

        public static List<PcbCardInfo> GetPcbsPage(int pageSize, int pageNumber, string? nameFilter = null)
        {
            var pcbs = new List<PcbCardInfo>();

            int offset = (pageNumber - 1) * pageSize;

            string sql = @"SELECT id, name, description, price, total_quantity, image_path FROM pcbs";
            

            var parameters = new List<NpgsqlParameter>
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += @" WHERE (name ILIKE @nameFilter)
                          ORDER BY 
                            CASE 
                              WHEN name ILIKE @namePatternStart THEN 1
                              WHEN name ILIKE @namePatternAny THEN 2
                              ELSE 3
                            END,
                            name";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternStart", $"{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternAny", $"%{nameFilter}%"));
            }
            else
            {
                sql += " ORDER BY id";
            }

            sql += " LIMIT @limit OFFSET @offset";

            var dataTable = Database.ExecuteDataTable(sql, parameters.ToArray());

            foreach (DataRow row in dataTable.Rows)
            {
                var pcbInfo = new PcbCardInfo(
                    id: Convert.ToInt32(row["id"]),
                    name: row["name"].ToString() ?? "",
                    description: row["description"].ToString() ?? "",
                    price: Convert.ToDouble(row["price"]),
                    quantity: Convert.ToInt32(row["total_quantity"]),
                    imagePath: row["image_path"].ToString()
                );
                pcbs.Add(pcbInfo);
            }

            return pcbs;
        }

        public static long GetTotalPcbsCount(string? nameFilter = null)
        {
            string sql = "SELECT COUNT(*) FROM pcbs";
            var parameters = new List<NpgsqlParameter>();

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += " WHERE name ILIKE @nameFilter";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
            }

            return Database.ExecuteScalar<long>(sql, parameters.ToArray());
        }

        public static List<PcbComboBoxItem> GetAllPcbsForComboBox()
        {
            var pcbs = new List<PcbComboBoxItem>();

            string sql = "SELECT id, name, serial_number, price FROM pcbs ORDER BY name";
            var dataTable = Database.ExecuteDataTable(sql);

            foreach (DataRow row in dataTable.Rows)
            {
                pcbs.Add(new PcbComboBoxItem
                {
                    Id = Convert.ToInt32(row["id"]),
                    Name = row["name"].ToString() ?? "",
                    SerialNumber = row["serial_number"].ToString() ?? "",
                    Price = Convert.ToDecimal(row["price"])
                });
            }

            return pcbs;
        }

        public class PcbComboBoxItem
        {
            public int Id { get; set; }
            public string Name { get; set; }
            public string SerialNumber { get; set; }
            public decimal Price { get; set; }

            // Свойство для удобного доступа к объекту Pcb
            public Pcb Pcb => new Pcb(Id, Name, SerialNumber, null, null, Price, 0, null, null, null, null, null, null);
        }

        public static Pcb? GetPcbById(int id)
        {
            string sql = "SELECT * FROM pcbs WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            return DataRowToPcb(dataTable.Rows[0]);
        }

        public static Pcb? GetPcbBySerialNumber(string serialNumber)
        {
            string sql = "SELECT * FROM pcbs WHERE serial_number = @serialNumber";
            var parameters = new[] { new NpgsqlParameter("@serialNumber", serialNumber) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            if (dataTable.Rows.Count == 0)
                return null;

            return DataRowToPcb(dataTable.Rows[0]);
        }

        public static int AddPcb(Pcb pcb, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO pcbs (name, serial_number, batch, description, price, total_quantity, 
                          manufacture_date, length, width, layers_count, comment, image_path)
                          VALUES (@name, @serialNumber, @batch, @description, @price, @totalQuantity, 
                          @manufactureDate, @length, @width, @layersCount, @comment, @imagePath)
                          RETURNING id";

            var parameters = new[]
            {
                new NpgsqlParameter("@name", pcb.Name),
                new NpgsqlParameter("@serialNumber", pcb.SerialNumber),
                new NpgsqlParameter("@batch", pcb.Batch ?? (object)DBNull.Value),
                new NpgsqlParameter("@description", pcb.Description ?? (object)DBNull.Value),
                new NpgsqlParameter("@price", pcb.Price),
                new NpgsqlParameter("@totalQuantity", pcb.TotalQuantity),
                new NpgsqlParameter("@manufactureDate", pcb.ManufactureDate ?? (object)DBNull.Value),
                new NpgsqlParameter("@length", pcb.Length ?? (object)DBNull.Value),
                new NpgsqlParameter("@width", pcb.Width ?? (object)DBNull.Value),
                new NpgsqlParameter("@layersCount", pcb.LayersCount ?? (object)DBNull.Value),
                new NpgsqlParameter("@comment", pcb.Comment ?? (object)DBNull.Value),
                new NpgsqlParameter("@imagePath", pcb.ImagePath ?? (object)DBNull.Value)
            };

            if (transaction == null)
            {
                return Database.ExecuteScalar<int>(sql, parameters);
            }
            else
            {
                return Database.ExecuteScalar<int>(sql, transaction, parameters);
            }
        }

        public static void UpdatePcb(Pcb pcb, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE pcbs SET name = @name, serial_number = @serialNumber, batch = @batch, 
                          description = @description, price = @price, total_quantity = @totalQuantity, 
                          manufacture_date = @manufactureDate, 
                          length = @length, width = @width, layers_count = @layersCount, 
                          comment = @comment, image_path = @imagePath 
                          WHERE id = @id";

            var parameters = new[]
            {
                new NpgsqlParameter("@name", pcb.Name),
                new NpgsqlParameter("@serialNumber", pcb.SerialNumber),
                new NpgsqlParameter("@batch", pcb.Batch ?? (object)DBNull.Value),
                new NpgsqlParameter("@description", pcb.Description ?? (object)DBNull.Value),
                new NpgsqlParameter("@price", pcb.Price),
                new NpgsqlParameter("@totalQuantity", pcb.TotalQuantity),
                new NpgsqlParameter("@manufactureDate", pcb.ManufactureDate ?? (object)DBNull.Value),
                new NpgsqlParameter("@length", pcb.Length ?? (object)DBNull.Value),
                new NpgsqlParameter("@width", pcb.Width ?? (object)DBNull.Value),
                new NpgsqlParameter("@layersCount", pcb.LayersCount ?? (object)DBNull.Value),
                new NpgsqlParameter("@comment", pcb.Comment ?? (object)DBNull.Value),
                new NpgsqlParameter("@imagePath", pcb.ImagePath ?? (object)DBNull.Value),
                new NpgsqlParameter("@id", pcb.Id)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeletePcb(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM pcbs WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        // PcbRepository.cs
        public static void DeletePcbWithComponents(int pcbId, NpgsqlTransaction? transaction = null)
        {
            // Получаем информацию о плате и её компонентах
            var pcb = GetPcbById(pcbId);
            if (pcb == null) return;

            var pcbComponents = GetPcbComponents(pcbId, transaction);

            // Возвращаем компоненты на склад
            foreach (var pcbComponent in pcbComponents)
            {
                var component = GetComponentById(pcbComponent.ComponentId, transaction);
                if (component != null)
                {
                    int returnedQuantity = pcbComponent.ComponentCount * pcb.TotalQuantity;
                    component.StockQuantity += returnedQuantity;
                    UpdateComponent(component, transaction);

                    // Запись о движении - возврат компонентов
                    AdditionalRepository.CreateComponentMovement("Поступление",
                        component.Id, returnedQuantity,
                        $"Возврат компонентов после удаления платы \"{pcb.Name}\"",
                        transaction);
                }
            }

            // Удаляем связи компонентов с платой
            string deleteComponentsSql = "DELETE FROM pcb_components WHERE pcb_id = @pcbId";
            var deleteParams = new[] { new NpgsqlParameter("@pcbId", pcbId) };

            if (transaction == null)
                Database.ExecuteNonQuery(deleteComponentsSql, deleteParams);
            else
                Database.ExecuteNonQuery(deleteComponentsSql, transaction, deleteParams);

            // Удаляем саму плату
            DeletePcb(pcbId, transaction);

            // Запись о движении - удаление плат
            AdditionalRepository.CreatePcbMovement("Списание", pcbId, pcb.TotalQuantity,
                $"Удаление платы \"{pcb.Name}\" администратором", transaction);
        }

        // ============ COMPONENT METHODS ==============

        public static List<ComponentCardInfo> GetFilteredComponentsPage(int pageSize, int pageNumber,
            string? nameFilter = null, string? typeFilter = null, int? pcbId = null)
        {
            var components = new List<ComponentCardInfo>();

            int offset = (pageNumber - 1) * pageSize;

            var parameters = new List<NpgsqlParameter>
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            string sql = "SELECT components.id, name, manufacturer, type, stock_quantity";

            if (pcbId != null)
            {
                sql += ", component_count, coordinates";
            }

            sql += " FROM components";

            if (pcbId != null)
            {
                sql += " JOIN pcb_components ON components.id = component_id";
            }

            sql += " WHERE 1=1";

            if (pcbId != null)
            {
                sql += " AND pcb_components.pcb_id = @pcbId";
                parameters.Add(new NpgsqlParameter("@pcbId", pcbId.Value));
            }

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                sql += " AND type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", typeFilter));
            }

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += @" AND (name ILIKE @nameFilter)
                  ORDER BY 
                    CASE 
                      WHEN name ILIKE @namePatternStart THEN 1
                      WHEN name ILIKE @namePatternAny THEN 2
                      ELSE 3
                    END,
                    name";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternStart", $"{nameFilter}%"));
                parameters.Add(new NpgsqlParameter("@namePatternAny", $"%{nameFilter}%"));
            }
            else
            {
                sql += " ORDER BY id";
            }

            sql += " LIMIT @limit OFFSET @offset";

            var dataTable = Database.ExecuteDataTable(sql, parameters.ToArray());

            foreach (DataRow row in dataTable.Rows)
            {
                var componentInfo = new ComponentCardInfo(
                    id: Convert.ToInt32(row["id"]),
                    name: row["name"].ToString() ?? "",
                    type: row["type"].ToString() ?? "",
                    manufacturer: row["manufacturer"].ToString(),
                    stockQuantity: Convert.ToInt32(row["stock_quantity"]),
                    pcbCount: pcbId.HasValue ? Convert.ToInt32(row["component_count"]) : null,
                    pcbCoordinates: pcbId.HasValue ? row["coordinates"].ToString() : null
                );
                components.Add(componentInfo);
            }

            return components;
        }

        public static long GetFilteredComponentsCount(string? nameFilter = null,
            string? typeFilter = null, int? pcbId = null)
        {
            string sql = "SELECT COUNT(*) FROM components";
            var parameters = new List<NpgsqlParameter>();

            if (pcbId.HasValue)
            {
                sql += " JOIN pcb_components ON components.id = pcb_components.component_id";
            }

            sql += " WHERE 1=1";

            if (pcbId.HasValue)
            {
                sql += " AND pcb_components.pcb_id = @pcbId";
                parameters.Add(new NpgsqlParameter("@pcbId", pcbId));
            }

            if (!string.IsNullOrEmpty(typeFilter) && typeFilter != "Все")
            {
                sql += " AND type = @typeFilter";
                parameters.Add(new NpgsqlParameter("@typeFilter", typeFilter));
            }

            if (!string.IsNullOrEmpty(nameFilter))
            {
                sql += " AND name ILIKE @nameFilter";
                parameters.Add(new NpgsqlParameter("@nameFilter", $"%{nameFilter}%"));
            }

            return Database.ExecuteScalar<long>(sql, parameters.ToArray());
        }

        public static List<string> GetComponentTypes()
        {
            var types = new List<string> { "Все" };

            string sql = "SELECT DISTINCT type FROM components WHERE type IS NOT NULL AND type != '' ORDER BY type";

            var dataTable = Database.ExecuteDataTable(sql);

            foreach (DataRow row in dataTable.Rows)
            {
                types.Add(row["type"].ToString() ?? "");
            }

            return types;
        }

        public static List<ComponentCardInfo> GetComponentsPage(int pageSize, int pageNumber)
        {
            var components = new List<ComponentCardInfo>();

            int offset = (pageNumber - 1) * pageSize;

            string sql = @"SELECT id, name, manufacturer, type, stock_quantity FROM components 
                          ORDER BY id 
                          LIMIT @limit OFFSET @offset";

            var parameters = new[]
            {
                new NpgsqlParameter("@limit", pageSize),
                new NpgsqlParameter("@offset", offset)
            };

            var dataTable = Database.ExecuteDataTable(sql, parameters);

            foreach (DataRow row in dataTable.Rows)
            {
                var componentInfo = new ComponentCardInfo(
                    id: Convert.ToInt32(row["id"]),
                    name: row["name"].ToString() ?? "",
                    type: row["type"].ToString() ?? "",
                    manufacturer: row["manufacturer"].ToString(),
                    stockQuantity: Convert.ToInt32(row["stock_quantity"])
                );
                components.Add(componentInfo);
            }

            return components;
        }

        public static long GetTotalComponentsCount()
        {
            string sql = "SELECT COUNT(*) FROM components";
            return Database.ExecuteScalar<long>(sql);
        }

        public static Component? GetComponentById(int id, NpgsqlTransaction? transaction = null)
        {
            DataTable dataTable;
            string sql = "SELECT * FROM components WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };

            if (transaction == null)
            {
                dataTable = Database.ExecuteDataTable(sql, parameters);
            }
            else
            {
                dataTable = Database.ExecuteDataTable(sql, transaction, parameters);
            }

            if (dataTable.Rows.Count == 0)
                return null;

            return DataRowToComponent(dataTable.Rows[0]);
        }

        public static int AddComponent(Component component, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO components (name, manufacturer, price, type, stock_quantity)
                          VALUES (@name, @manufacturer, @price, @type, @stockQuantity)
                          RETURNING id";

            var parameters = new[]
            {
                new NpgsqlParameter("@name", component.Name),
                new NpgsqlParameter("@manufacturer", component.Manufacturer ?? (object)DBNull.Value),
                new NpgsqlParameter("@price", component.Price),
                new NpgsqlParameter("@type", component.Type ?? (object)DBNull.Value),
                new NpgsqlParameter("@stockQuantity", component.StockQuantity)
            };

            if (transaction == null)
            {
                return Database.ExecuteScalar<int>(sql, parameters);
            }
            else
            {
                return Database.ExecuteScalar<int>(sql, transaction, parameters);
            }
        }

        public static void UpdateComponent(Component component, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE components SET name = @name, manufacturer = @manufacturer, 
                          price = @price, type = @type, stock_quantity = @stockQuantity 
                          WHERE id = @id";

            var parameters = new[]
            {
                new NpgsqlParameter("@name", component.Name),
                new NpgsqlParameter("@manufacturer", component.Manufacturer ?? (object)DBNull.Value),
                new NpgsqlParameter("@price", component.Price),
                new NpgsqlParameter("@type", component.Type ?? (object)DBNull.Value),
                new NpgsqlParameter("@stockQuantity", component.StockQuantity),
                new NpgsqlParameter("@id", component.Id)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static List<string> GetOtherComponentNames(int pcbId)
        {
            List<string> names = new List<string>();
            string sql = @"SELECT c.name FROM components c WHERE NOT EXISTS (
                          SELECT 1 FROM pcb_components pc WHERE pc.component_id = c.id
                          AND pc.pcb_id = @pcbId) ORDER BY c.name";

            var parameters = new[] { new NpgsqlParameter("@pcbId", pcbId) };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            foreach (DataRow row in dataTable.Rows)
            {
                names.Add(row["name"].ToString() ?? "");
            }

            return names;
        }

        public static int GetComponentIdByName(string name)
        {
            string sql = "SELECT id FROM components WHERE name = @name";
            var parameters = new[] { new NpgsqlParameter("@name", name) };
            return Database.ExecuteScalar<int>(sql, parameters);
        }

        public static void DeleteComponent(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM components WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        // ========== COMPONENT SPECIFICATION METHODS ==========

        public static List<ComponentSpecification> GetComponentSpecifications(int componentId, NpgsqlTransaction? transaction = null)
        {
            string sql = "SELECT * FROM component_specifications WHERE component_id = @componentId";
            var parameters = new[] { new NpgsqlParameter("@componentId", componentId) };
            DataTable dataTable;

            if (transaction == null)
            {
                dataTable = Database.ExecuteDataTable(sql, parameters);
            }
            else
            {
                dataTable = Database.ExecuteDataTable(sql, transaction, parameters);
            }

            return DataTableToComponentSpecificationList(dataTable);
        }

        public static void AddComponentSpecification(ComponentSpecification specification, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO component_specifications (component_id, specification, specification_value)
                          VALUES (@componentId, @specification, @specificationValue)";

            var parameters = new[]
            {
                new NpgsqlParameter("@componentId", specification.ComponentId),
                new NpgsqlParameter("@specification", specification.Specification),
                new NpgsqlParameter("@specificationValue", specification.SpecificationValue)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteComponentSpecification(int id, NpgsqlTransaction? transaction = null)
        {
            string sql = "DELETE FROM component_specifications WHERE id = @id";
            var parameters = new[] { new NpgsqlParameter("@id", id) };
            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeleteComponentWithCleanup(int componentId, NpgsqlTransaction? transaction = null)
        {
            var component = GetComponentById(componentId, transaction);
            if (component == null) return;

            string deleteSpecsSql = "DELETE FROM component_specifications WHERE component_id = @componentId";
            var deleteSpecsParams = new[] { new NpgsqlParameter("@componentId", componentId) };

            if (transaction == null)
                Database.ExecuteNonQuery(deleteSpecsSql, deleteSpecsParams);
            else
                Database.ExecuteNonQuery(deleteSpecsSql, transaction, deleteSpecsParams);

            // Удаляем связи с платами
            string deletePcbLinksSql = "DELETE FROM pcb_components WHERE component_id = @componentId";
            var deletePcbLinksParams = new[] { new NpgsqlParameter("@componentId", componentId) };

            if (transaction == null)
                Database.ExecuteNonQuery(deletePcbLinksSql, deletePcbLinksParams);
            else
                Database.ExecuteNonQuery(deletePcbLinksSql, transaction, deletePcbLinksParams);

            DeleteComponent(componentId, transaction);

            AdditionalRepository.CreateComponentMovement("Списание", componentId, component.StockQuantity,
                $"Удаление компонента \"{component.Name}\" администратором", transaction);
        }

        // ========== PCB COMPONENT METHODS ==========

        public static List<PcbComponent> GetPcbComponents(int pcbId, NpgsqlTransaction? transaction = null)
        {
            DataTable dataTable;
            string sql = "SELECT * FROM pcb_components WHERE pcb_id = @pcbId";
            var parameters = new[] { new NpgsqlParameter("@pcbId", pcbId) };

            if (transaction == null)
            {
                dataTable = Database.ExecuteDataTable(sql, parameters);
            }
            else
            {
                dataTable = Database.ExecuteDataTable(sql, transaction, parameters);
            }
            
            return DataTableToPcbComponentList(dataTable);
        }

        public static List<Pcb> GetComponentPcbs(int componentId, NpgsqlTransaction? transaction = null)
        {
            DataTable dataTable;
            string sql = @"SELECT * FROM pcbs JOIN pcb_components ON pcbs.id = pcb_id
                          WHERE component_id = @componentId";
            var parameters = new[] { new NpgsqlParameter("@componentId", componentId) };

            if (transaction == null)
            {
                dataTable = Database.ExecuteDataTable(sql, parameters);
            }
            else
            {
                dataTable = Database.ExecuteDataTable(sql, transaction, parameters);
            }

            return DataTableToComponentPcbList(dataTable);
        }

        public static PcbComponent GetPcbComponent(int pcbId, int componentId)
        {
            string sql = "SELECT * FROM pcb_components WHERE pcb_id = @pcbId AND component_id = @componentId";
            var parameters = new[]
            {
                new NpgsqlParameter("@pcbId", pcbId),
                new NpgsqlParameter("@componentId", componentId)
            };

            var dataTable = Database.ExecuteDataTable(sql, parameters);
            return new PcbComponent(
                pcbId: Convert.ToInt32(dataTable.Rows[0]["pcb_id"]),
                componentId: Convert.ToInt32(dataTable.Rows[0]["component_id"]),
                componentCount: Convert.ToInt32(dataTable.Rows[0]["component_count"]),
                coordinates: dataTable.Rows[0]["coordinates"].ToString()
                );
        }

        public static void AddPcbComponent(PcbComponent pcbComponent, NpgsqlTransaction? transaction = null)
        {
            string sql = @"INSERT INTO pcb_components (pcb_id, component_id, component_count, coordinates)
                          VALUES (@pcbId, @componentId, @componentCount, @coordinates)";

            var parameters = new[]
            {
                new NpgsqlParameter("@pcbId", pcbComponent.PcbId),
                new NpgsqlParameter("@componentId", pcbComponent.ComponentId),
                new NpgsqlParameter("@componentCount", pcbComponent.ComponentCount),
                new NpgsqlParameter("@coordinates", pcbComponent.Coordinates ?? (object)DBNull.Value)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void UpdatePcbComponent(PcbComponent pcbComponent, NpgsqlTransaction? transaction = null)
        {
            string sql = @"UPDATE pcb_components SET component_count = @componentCount, coordinates = @coordinates
                            WHERE pcb_id = @pcbId AND component_id = @componentId";

            var parameters = new[]
            {
                new NpgsqlParameter("@pcbId", pcbComponent.PcbId),
                new NpgsqlParameter("@componentId", pcbComponent.ComponentId),
                new NpgsqlParameter("@componentCount", pcbComponent.ComponentCount),
                new NpgsqlParameter("@coordinates", pcbComponent.Coordinates ?? (object)DBNull.Value)
            };

            if (transaction == null)
            {
                Database.ExecuteNonQuery(sql, parameters);
            }
            else
            {
                Database.ExecuteNonQuery(sql, transaction, parameters);
            }
        }

        public static void DeletePcbComponent(int pcbId, int componentId)
        {
            string sql = "DELETE FROM pcb_components WHERE pcb_id = @pcbId AND component_id = @componentId";
            var parameters = new[] 
            { 
                new NpgsqlParameter("@pcbId", pcbId),
                new NpgsqlParameter("@componentId", componentId)
            };
            Database.ExecuteNonQuery(sql, parameters);
        }

        // ========== HELPER METHODS ==========

        private static List<Pcb> DataTableToPcbList(DataTable dataTable)
        {
            var pcbs = new List<Pcb>();
            foreach (DataRow row in dataTable.Rows)
            {
                pcbs.Add(DataRowToPcb(row));
            }
            return pcbs;
        }

        private static Pcb DataRowToPcb(DataRow row)
        {
            return new Pcb(
                id: Convert.ToInt32(row["id"]),
                name: row["name"].ToString() ?? "",
                serialNumber: row["serial_number"].ToString() ?? "",
                batch: row["batch"].ToString(),
                description: row["description"].ToString(),
                price: Convert.ToDecimal(row["price"]),
                totalQuantity: Convert.ToInt32(row["total_quantity"]),
                manufactureDate: row["manufacture_date"] == DBNull.Value ? null : Convert.ToDateTime(row["manufacture_date"]),
                length: row["length"] == DBNull.Value ? null : Convert.ToDecimal(row["length"]),
                width: row["width"] == DBNull.Value ? null : Convert.ToDecimal(row["width"]),
                layersCount: row["layers_count"] == DBNull.Value ? null : Convert.ToInt32(row["layers_count"]),
                comment: row["comment"].ToString(),
                imagePath: row["image_path"].ToString()
            );
        }

        private static List<Component> DataTableToComponentList(DataTable dataTable)
        {
            var components = new List<Component>();
            foreach (DataRow row in dataTable.Rows)
            {
                components.Add(DataRowToComponent(row));
            }
            return components;
        }

        private static Component DataRowToComponent(DataRow row)
        {
            return new Component(
                id: Convert.ToInt32(row["id"]),
                name: row["name"].ToString() ?? "",
                manufacturer: row["manufacturer"].ToString(),
                price: Convert.ToDecimal(row["price"]),
                type: row["type"].ToString(),
                stockQuantity: Convert.ToInt32(row["stock_quantity"]),
                createdAt: Convert.ToDateTime(row["created_at"])
            );
        }

        private static List<ComponentSpecification> DataTableToComponentSpecificationList(DataTable dataTable)
        {
            var specifications = new List<ComponentSpecification>();
            foreach (DataRow row in dataTable.Rows)
            {
                specifications.Add(new ComponentSpecification(
                    id: Convert.ToInt32(row["id"]),
                    componentId: Convert.ToInt32(row["component_id"]),
                    specification: row["specification"].ToString() ?? "",
                    specificationValue: row["specification_value"].ToString() ?? ""
                ));
            }
            return specifications;
        }

        private static List<PcbComponent> DataTableToPcbComponentList(DataTable dataTable)
        {
            var pcbComponents = new List<PcbComponent>();
            foreach (DataRow row in dataTable.Rows)
            {
                pcbComponents.Add(new PcbComponent(
                    pcbId: Convert.ToInt32(row["pcb_id"]),
                    componentId: Convert.ToInt32(row["component_id"]),
                    componentCount: Convert.ToInt32(row["component_count"]),
                    coordinates: row["coordinates"].ToString()
                ));
            }
            return pcbComponents;
        }

        private static List<Pcb> DataTableToComponentPcbList(DataTable dataTable)
        {
            var pcbs = new List<Pcb>();
            foreach (DataRow row in dataTable.Rows)
            {
                pcbs.Add(DataRowToPcb(row));
            }
            return pcbs;
        }
    }
}

// =============================================================================
// ФАЙЛ: PcbsListForm.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\PcbsListForm.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Printing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public partial class PcbsListForm : Form
    {
        private int _pageSize = 3;
        private int _currentPage = 1;
        private int _totalPages = 1;
        private string _currentNameFilter = "";
        private Label _noResultsLabel;

        public PcbsListForm()
        {
            InitializeComponent();
            SettingsUI.ApplyStyle(this);

            InitializeNoResultsLabel();
            LoadPcbsPage();
            UpdatePaginationButtons();
        }

        private void InitializeNoResultsLabel()
        {
            _noResultsLabel = new Label();
            _noResultsLabel.Text = "Платы не найдены";
            _noResultsLabel.AutoSize = true;
            _noResultsLabel.Font = new Font("Times New Roman", 12F, FontStyle.Italic, GraphicsUnit.Point, 204);
            _noResultsLabel.ForeColor = Color.Gray;
            _noResultsLabel.Visible = false;
            flowLayoutPanel1.Controls.Add(_noResultsLabel);
        }

        private void LoadPcbsPage()
        {
            flowLayoutPanel1.Controls.Clear();
            flowLayoutPanel1.Controls.Add(_noResultsLabel);

            var pcbs = PcbRepository.GetPcbsPage(_pageSize, _currentPage, _currentNameFilter);
            long totalPcbs = PcbRepository.GetTotalPcbsCount(_currentNameFilter);
            _totalPages = (int)Math.Ceiling((double)totalPcbs / _pageSize);

            if (_totalPages == 0) _totalPages = 1;

            if (pcbs.Count == 0)
            {
                _noResultsLabel.Visible = true;
            }
            else
            {
                _noResultsLabel.Visible = false;

                foreach (var info in pcbs)
                {
                    var card = new PcbCard(info);
                    card.Click += Card_Click!;
                    flowLayoutPanel1.Controls.Add(card);
                }
            }

            UpdatePageInfo();
            UpdatePaginationButtons();
        }

        private void Card_Click(object sender, EventArgs e)
        {
            var card = (PcbCard)sender;
            new EditPcbForm(card.Id).ShowDialog();
            LoadPcbsPage();
        }

        private void UpdatePageInfo()
        {
            PageLabel.Text = $"Страница {_currentPage} из {_totalPages}";
        }

        private void UpdatePaginationButtons()
        {
            PrevButton.Enabled = _currentPage > 1;
            NextButton.Enabled = _currentPage < _totalPages;
        }

        private void PrevPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                LoadPcbsPage();
            }
        }

        private void NextPageButton_Click(object sender, EventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                LoadPcbsPage();
            }
        }

        private void AddPcbButton_Click(object sender, EventArgs e)
        {
            new EditPcbForm().ShowDialog();
            LoadPcbsPage();
        }

        private void FilterButton_Click(object sender, EventArgs e)
        {
            _currentNameFilter = NameFilterTextBox.Text.Trim();

            _currentPage = 1;

            LoadPcbsPage();
        }

        private void CloseButton_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void NameFilterTextBox_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                FilterButton_Click(sender, e);
                e.Handled = true;
            }
        }
    }
}

// =============================================================================
// ФАЙЛ: Program.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\Program.cs
// =============================================================================

namespace ElectronicsFactory
{
    internal static class Program
    {
        /// <summary>
        ///  The main entry point for the application.
        /// </summary>
        [STAThread]
        static void Main()
        {
            // To customize application configuration such as set high DPI settings or default font,
            // see https://aka.ms/applicationconfiguration.
            ApplicationConfiguration.Initialize();
            Database.Initialize("Host=localhost;Database=ElectronicsFactory;Port=5432;Username=postgres;Password=virtual");
            Application.Run(new AuthorizationForm());
        }
    }
}

// =============================================================================
// ФАЙЛ: Settings.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\Settings.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    public static class Settings
    {
        public static bool IsAdmin { get; set; } = false;
        public static int CurrentEmployeeId { get; set; }
        public static string CurrentEmployeeName { get; set; } = "";
    }
}


// =============================================================================
// ФАЙЛ: SettingsUI.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\SettingsUI.cs
// =============================================================================

using System.Drawing;
using System.Windows.Forms;

namespace ElectronicsFactory
{
    public static class SettingsUI
    {
        // --------------------------------------------------------------------
        // ГЛОБАЛЬНАЯ ЦВЕТОВАЯ ПАЛИТРА
        // --------------------------------------------------------------------

        // Основной фон всех форм
        public static Color BackColor = Color.FromArgb(15, 18, 30);

        // Фон карточек, панелей, DataGridView-строк
        public static Color CardBackColor = Color.FromArgb(25, 28, 40);

        // Акцент (кнопки, заголовки)
        public static Color AccentColor = Color.FromArgb(120, 80, 200);
        public static Color AccentHover = Color.FromArgb(150, 100, 230);

        // Дополнительные цвета
        public static Color BorderColor = Color.FromArgb(70, 70, 100);
        public static Color TextColor = Color.FromArgb(210, 210, 230);
        public static Color SecondaryText = Color.FromArgb(160, 160, 200);

        // --------------------------------------------------------------------
        // ШРИФТЫ
        // --------------------------------------------------------------------
        public static Font DefaultFont = new Font("Times New Roman", 11f, FontStyle.Regular);
        public static Font HeaderFont = new Font("Times New Roman", 13f, FontStyle.Bold);
        public static Font SmallFont = new Font("Times New Roman", 10f, FontStyle.Regular);


        // ====================================================================
        //                ПРИМЕНЕНИЕ СТИЛЯ КО ВСЕЙ ФОРМЕ
        // ====================================================================
        public static void ApplyStyle(Form form)
        {
            form.BackColor = BackColor;
            form.Font = DefaultFont;
            form.Icon = Icon.FromHandle(Properties.Resources.circuit_placeholder_old.GetHicon());

            ApplyStyleToControls(form.Controls);
        }


        // Рекурсивная стилизация всех вложенных контролов
        private static void ApplyStyleToControls(Control.ControlCollection controls)
        {
            foreach (Control c in controls)
            {
                if (c is Button btn) StyleButton(btn);
                else if (c is TextBox tb) StyleTextBox(tb);
                else if (c is ComboBox cb) StyleComboBox(cb);
                else if (c is Label lbl) StyleLabel(lbl);
                else if (c is NumericUpDown nud) StyleNumeric(nud);
                else if (c is DataGridView dgv) StyleDataGrid(dgv);
                else if (c is DateTimePicker dtp) StyleDate(dtp);
                else if (c is Panel p) p.BackColor = BackColor;

                c.ForeColor = TextColor;
                c.Font = DefaultFont;

                if (c.HasChildren)
                    ApplyStyleToControls(c.Controls);
            }
        }


        // ====================================================================
        //                                BUTTONS
        // ====================================================================
        public static void StyleButton(Button btn)
        {
            btn.FlatStyle = FlatStyle.Flat;
            btn.FlatAppearance.BorderSize = 0;

            btn.BackColor = AccentColor;
            btn.ForeColor = Color.White;
            btn.Font = DefaultFont;

            btn.Cursor = Cursors.Hand;

            // Плавный hover
            btn.MouseEnter += (s, e) => btn.BackColor = AccentHover;
            btn.MouseLeave += (s, e) => btn.BackColor = AccentColor;
        }


        // ====================================================================
        //                                TEXTBOX
        // ====================================================================
        public static void StyleTextBox(TextBox tb)
        {
            tb.BorderStyle = BorderStyle.FixedSingle;
            tb.BackColor = CardBackColor;
            tb.ForeColor = TextColor;
        }


        // ====================================================================
        //                                COMBOBOX
        // ====================================================================
        public static void StyleComboBox(ComboBox cb)
        {
            cb.DropDownStyle = ComboBoxStyle.DropDownList;
            cb.BackColor = AccentColor;
            cb.ForeColor = TextColor;
        }


        // ====================================================================
        //                                LABEL
        // ====================================================================
        public static void StyleLabel(Label lbl)
        {
            lbl.ForeColor = TextColor;
            lbl.BackColor = Color.Transparent;
        }


        // ====================================================================
        //                         NUMERIC UP/DOWN
        // ====================================================================
        public static void StyleNumeric(NumericUpDown nud)
        {
            nud.BorderStyle = BorderStyle.FixedSingle;
            nud.BackColor = CardBackColor;
            nud.ForeColor = TextColor;
        }


        // ====================================================================
        //                         DATETIMEPICKER
        // ====================================================================
        public static void StyleDate(DateTimePicker dtp)
        {
            dtp.BackColor = CardBackColor;
            dtp.ForeColor = TextColor;
        }


        // ====================================================================
        //                            CARD USERCONTROLS
        // ====================================================================
        public static void StyleCard(UserControl uc)
        {
            uc.BackColor = CardBackColor;
            uc.BorderStyle = BorderStyle.FixedSingle;
        }


        // ====================================================================
        //                              DATA GRID VIEW
        // ====================================================================
        public static void StyleDataGrid(DataGridView dgv)
        {
            dgv.BackgroundColor = BackColor;
            dgv.GridColor = BorderColor;

            dgv.EnableHeadersVisualStyles = false;

            dgv.ColumnHeadersDefaultCellStyle.BackColor = AccentColor;
            dgv.ColumnHeadersDefaultCellStyle.ForeColor = Color.White;
            dgv.ColumnHeadersDefaultCellStyle.Font = DefaultFont;

            dgv.DefaultCellStyle.BackColor = CardBackColor;
            dgv.DefaultCellStyle.ForeColor = TextColor;
            dgv.DefaultCellStyle.SelectionBackColor = AccentHover;
            dgv.DefaultCellStyle.SelectionForeColor = Color.White;

            dgv.RowHeadersVisible = false;
            dgv.BorderStyle = BorderStyle.None;
        }
    }
}


// =============================================================================
// ФАЙЛ: Utils.cs
// ПОЛНЫЙ ПУТЬ: D:\4 курс\ПМ 02\Сергеев\ElectronicsFactory\ElectronicsFactory\Utils.cs
// =============================================================================

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ElectronicsFactory
{
    public class Utils
    {
        public static void ShowErrorMessage(string text, string title = "Ошибка")
        {
            MessageBox.Show(text, title, MessageBoxButtons.OK, MessageBoxIcon.Error);
        }

        public static void ShowInfoMessage(string text, string title = "")
        {
            MessageBox.Show(text, title, MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        public static DialogResult ShowQuestionMessage(string text = "Изменённые данные не будут сохранены. Вы уверены?",
            string title = "Предупреждение")
        {
            return MessageBox.Show(text, title, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
        }
    }
}


// =============================================================================
// КОНЕЦ ОБЪЕДИНЕНИЯ
// =============================================================================
